<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>慕课实战：Node.js 从零开发 web server博客项目 前端晋升全栈工程师必备 | Roundtable Coders</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="manifest" href="/Roundtable/manifest.json">
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico">
    <script src="./js/search.js"></script>
    <script src="./js/main.js"></script>
    <meta name="description" content="A knowledge base created by ESOP-FED">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/Roundtable/assets/css/0.styles.473b2e6f.css" as="style"><link rel="preload" href="/Roundtable/assets/js/app.2a67b391.js" as="script"><link rel="preload" href="/Roundtable/assets/js/3.732c8675.js" as="script"><link rel="preload" href="/Roundtable/assets/js/75.06e98b0d.js" as="script"><link rel="prefetch" href="/Roundtable/assets/js/10.70a3801e.js"><link rel="prefetch" href="/Roundtable/assets/js/100.6d4d41b2.js"><link rel="prefetch" href="/Roundtable/assets/js/101.fcca3442.js"><link rel="prefetch" href="/Roundtable/assets/js/102.be877f9d.js"><link rel="prefetch" href="/Roundtable/assets/js/103.a3013f74.js"><link rel="prefetch" href="/Roundtable/assets/js/104.790e4ad7.js"><link rel="prefetch" href="/Roundtable/assets/js/105.fa290a0c.js"><link rel="prefetch" href="/Roundtable/assets/js/106.6cdd50e8.js"><link rel="prefetch" href="/Roundtable/assets/js/107.3360e87b.js"><link rel="prefetch" href="/Roundtable/assets/js/108.b272cdae.js"><link rel="prefetch" href="/Roundtable/assets/js/109.0d37c586.js"><link rel="prefetch" href="/Roundtable/assets/js/11.3046242f.js"><link rel="prefetch" href="/Roundtable/assets/js/110.9133ded6.js"><link rel="prefetch" href="/Roundtable/assets/js/111.2bb986d4.js"><link rel="prefetch" href="/Roundtable/assets/js/112.ff4b597c.js"><link rel="prefetch" href="/Roundtable/assets/js/113.db617ac9.js"><link rel="prefetch" href="/Roundtable/assets/js/114.e0aa3101.js"><link rel="prefetch" href="/Roundtable/assets/js/115.cae2a328.js"><link rel="prefetch" href="/Roundtable/assets/js/116.407db280.js"><link rel="prefetch" href="/Roundtable/assets/js/117.c15103af.js"><link rel="prefetch" href="/Roundtable/assets/js/118.d45ea389.js"><link rel="prefetch" href="/Roundtable/assets/js/119.8cccbd3c.js"><link rel="prefetch" href="/Roundtable/assets/js/12.74240992.js"><link rel="prefetch" href="/Roundtable/assets/js/120.ad57c2ac.js"><link rel="prefetch" href="/Roundtable/assets/js/121.321491cb.js"><link rel="prefetch" href="/Roundtable/assets/js/122.5b9cb99e.js"><link rel="prefetch" href="/Roundtable/assets/js/123.3693283f.js"><link rel="prefetch" href="/Roundtable/assets/js/124.f2f94bcd.js"><link rel="prefetch" href="/Roundtable/assets/js/125.800e216a.js"><link rel="prefetch" href="/Roundtable/assets/js/126.ccfa7506.js"><link rel="prefetch" href="/Roundtable/assets/js/127.827d6fd0.js"><link rel="prefetch" href="/Roundtable/assets/js/128.4bb30b21.js"><link rel="prefetch" href="/Roundtable/assets/js/129.4bd1cde6.js"><link rel="prefetch" href="/Roundtable/assets/js/13.cb9adb73.js"><link rel="prefetch" href="/Roundtable/assets/js/130.7fcf95f5.js"><link rel="prefetch" href="/Roundtable/assets/js/131.3fe83ad0.js"><link rel="prefetch" href="/Roundtable/assets/js/132.6d1cf839.js"><link rel="prefetch" href="/Roundtable/assets/js/133.d7c0179f.js"><link rel="prefetch" href="/Roundtable/assets/js/134.0ab1bbd2.js"><link rel="prefetch" href="/Roundtable/assets/js/135.4799fc28.js"><link rel="prefetch" href="/Roundtable/assets/js/136.a9857742.js"><link rel="prefetch" href="/Roundtable/assets/js/137.de32658f.js"><link rel="prefetch" href="/Roundtable/assets/js/138.131970d4.js"><link rel="prefetch" href="/Roundtable/assets/js/139.510eca2c.js"><link rel="prefetch" href="/Roundtable/assets/js/14.84cf25a4.js"><link rel="prefetch" href="/Roundtable/assets/js/140.31d81849.js"><link rel="prefetch" href="/Roundtable/assets/js/141.ecab44ef.js"><link rel="prefetch" href="/Roundtable/assets/js/142.9b87f059.js"><link rel="prefetch" href="/Roundtable/assets/js/143.9e78db1a.js"><link rel="prefetch" href="/Roundtable/assets/js/144.747a1adb.js"><link rel="prefetch" href="/Roundtable/assets/js/145.ecb740c7.js"><link rel="prefetch" href="/Roundtable/assets/js/146.0e517c82.js"><link rel="prefetch" href="/Roundtable/assets/js/147.d49abd2f.js"><link rel="prefetch" href="/Roundtable/assets/js/148.7267563b.js"><link rel="prefetch" href="/Roundtable/assets/js/149.5e31edca.js"><link rel="prefetch" href="/Roundtable/assets/js/15.41b69e8d.js"><link rel="prefetch" href="/Roundtable/assets/js/150.7bc85a86.js"><link rel="prefetch" href="/Roundtable/assets/js/151.1b7df4d0.js"><link rel="prefetch" href="/Roundtable/assets/js/152.5135ca06.js"><link rel="prefetch" href="/Roundtable/assets/js/153.bf2198df.js"><link rel="prefetch" href="/Roundtable/assets/js/154.dd398659.js"><link rel="prefetch" href="/Roundtable/assets/js/155.60d49601.js"><link rel="prefetch" href="/Roundtable/assets/js/156.9e37bcf0.js"><link rel="prefetch" href="/Roundtable/assets/js/157.21487c71.js"><link rel="prefetch" href="/Roundtable/assets/js/158.249ec3e8.js"><link rel="prefetch" href="/Roundtable/assets/js/159.5f6b4574.js"><link rel="prefetch" href="/Roundtable/assets/js/16.fc0a01fe.js"><link rel="prefetch" href="/Roundtable/assets/js/160.a53feb2a.js"><link rel="prefetch" href="/Roundtable/assets/js/161.a8337587.js"><link rel="prefetch" href="/Roundtable/assets/js/162.fc15fdde.js"><link rel="prefetch" href="/Roundtable/assets/js/163.4b7c8177.js"><link rel="prefetch" href="/Roundtable/assets/js/164.025fcf3b.js"><link rel="prefetch" href="/Roundtable/assets/js/165.ef23ebf7.js"><link rel="prefetch" href="/Roundtable/assets/js/166.038dc924.js"><link rel="prefetch" href="/Roundtable/assets/js/167.29b0c6f9.js"><link rel="prefetch" href="/Roundtable/assets/js/168.105a5ee7.js"><link rel="prefetch" href="/Roundtable/assets/js/169.49931161.js"><link rel="prefetch" href="/Roundtable/assets/js/17.6115e7ae.js"><link rel="prefetch" href="/Roundtable/assets/js/170.d425a26e.js"><link rel="prefetch" href="/Roundtable/assets/js/171.4ae8ecd7.js"><link rel="prefetch" href="/Roundtable/assets/js/172.b299c9c5.js"><link rel="prefetch" href="/Roundtable/assets/js/173.1420b439.js"><link rel="prefetch" href="/Roundtable/assets/js/174.9be3cfdc.js"><link rel="prefetch" href="/Roundtable/assets/js/175.2a1a6b86.js"><link rel="prefetch" href="/Roundtable/assets/js/176.d0f4b4d3.js"><link rel="prefetch" href="/Roundtable/assets/js/177.a258c9e6.js"><link rel="prefetch" href="/Roundtable/assets/js/178.9935fc45.js"><link rel="prefetch" href="/Roundtable/assets/js/179.920c93cb.js"><link rel="prefetch" href="/Roundtable/assets/js/18.f1a49ff6.js"><link rel="prefetch" href="/Roundtable/assets/js/180.45647437.js"><link rel="prefetch" href="/Roundtable/assets/js/181.455ff928.js"><link rel="prefetch" href="/Roundtable/assets/js/182.48d5397a.js"><link rel="prefetch" href="/Roundtable/assets/js/183.50a1f034.js"><link rel="prefetch" href="/Roundtable/assets/js/184.f3ebafc0.js"><link rel="prefetch" href="/Roundtable/assets/js/185.c4ec70bf.js"><link rel="prefetch" href="/Roundtable/assets/js/186.95c65138.js"><link rel="prefetch" href="/Roundtable/assets/js/187.1d93070c.js"><link rel="prefetch" href="/Roundtable/assets/js/188.f2fd4622.js"><link rel="prefetch" href="/Roundtable/assets/js/189.929d7460.js"><link rel="prefetch" href="/Roundtable/assets/js/19.d0f5a2a6.js"><link rel="prefetch" href="/Roundtable/assets/js/190.d7753e79.js"><link rel="prefetch" href="/Roundtable/assets/js/191.164337ba.js"><link rel="prefetch" href="/Roundtable/assets/js/192.073fa32a.js"><link rel="prefetch" href="/Roundtable/assets/js/193.a41f613a.js"><link rel="prefetch" href="/Roundtable/assets/js/194.ff356ef2.js"><link rel="prefetch" href="/Roundtable/assets/js/195.da2cb5f0.js"><link rel="prefetch" href="/Roundtable/assets/js/196.27aa5846.js"><link rel="prefetch" href="/Roundtable/assets/js/197.dbd4ea86.js"><link rel="prefetch" href="/Roundtable/assets/js/198.2341d363.js"><link rel="prefetch" href="/Roundtable/assets/js/199.dca16941.js"><link rel="prefetch" href="/Roundtable/assets/js/20.2b68ff2a.js"><link rel="prefetch" href="/Roundtable/assets/js/200.0f555a22.js"><link rel="prefetch" href="/Roundtable/assets/js/201.c636a8c2.js"><link rel="prefetch" href="/Roundtable/assets/js/202.00058dde.js"><link rel="prefetch" href="/Roundtable/assets/js/203.2eea9503.js"><link rel="prefetch" href="/Roundtable/assets/js/204.6e549015.js"><link rel="prefetch" href="/Roundtable/assets/js/205.5057b08b.js"><link rel="prefetch" href="/Roundtable/assets/js/206.cfbe6788.js"><link rel="prefetch" href="/Roundtable/assets/js/207.9246b65b.js"><link rel="prefetch" href="/Roundtable/assets/js/208.a106f85b.js"><link rel="prefetch" href="/Roundtable/assets/js/209.ae5edced.js"><link rel="prefetch" href="/Roundtable/assets/js/21.06c46f7a.js"><link rel="prefetch" href="/Roundtable/assets/js/210.cde0d451.js"><link rel="prefetch" href="/Roundtable/assets/js/211.56841a89.js"><link rel="prefetch" href="/Roundtable/assets/js/212.a2513586.js"><link rel="prefetch" href="/Roundtable/assets/js/213.548d24cc.js"><link rel="prefetch" href="/Roundtable/assets/js/214.076a26db.js"><link rel="prefetch" href="/Roundtable/assets/js/215.383c3c60.js"><link rel="prefetch" href="/Roundtable/assets/js/216.70ac75ec.js"><link rel="prefetch" href="/Roundtable/assets/js/217.7b2d6be8.js"><link rel="prefetch" href="/Roundtable/assets/js/218.cac91c4c.js"><link rel="prefetch" href="/Roundtable/assets/js/219.c8023d2a.js"><link rel="prefetch" href="/Roundtable/assets/js/22.ad9a9484.js"><link rel="prefetch" href="/Roundtable/assets/js/220.9f37e38b.js"><link rel="prefetch" href="/Roundtable/assets/js/221.ef07e5bb.js"><link rel="prefetch" href="/Roundtable/assets/js/222.a9351166.js"><link rel="prefetch" href="/Roundtable/assets/js/223.dda0229f.js"><link rel="prefetch" href="/Roundtable/assets/js/224.a6ce1883.js"><link rel="prefetch" href="/Roundtable/assets/js/225.632899a5.js"><link rel="prefetch" href="/Roundtable/assets/js/226.dd36ba08.js"><link rel="prefetch" href="/Roundtable/assets/js/227.1a84d25d.js"><link rel="prefetch" href="/Roundtable/assets/js/228.1ebb1e82.js"><link rel="prefetch" href="/Roundtable/assets/js/229.7e027b19.js"><link rel="prefetch" href="/Roundtable/assets/js/23.beb2862d.js"><link rel="prefetch" href="/Roundtable/assets/js/230.8fb55ecc.js"><link rel="prefetch" href="/Roundtable/assets/js/231.8145ad1c.js"><link rel="prefetch" href="/Roundtable/assets/js/232.0666f1b6.js"><link rel="prefetch" href="/Roundtable/assets/js/233.ad938079.js"><link rel="prefetch" href="/Roundtable/assets/js/234.0a0c6de3.js"><link rel="prefetch" href="/Roundtable/assets/js/235.70722d8a.js"><link rel="prefetch" href="/Roundtable/assets/js/236.508ff7cd.js"><link rel="prefetch" href="/Roundtable/assets/js/237.6fabed14.js"><link rel="prefetch" href="/Roundtable/assets/js/238.2441d3f4.js"><link rel="prefetch" href="/Roundtable/assets/js/239.ecbde05c.js"><link rel="prefetch" href="/Roundtable/assets/js/24.a4520e87.js"><link rel="prefetch" href="/Roundtable/assets/js/240.bcb7503a.js"><link rel="prefetch" href="/Roundtable/assets/js/241.0f39d71e.js"><link rel="prefetch" href="/Roundtable/assets/js/242.49c23a2b.js"><link rel="prefetch" href="/Roundtable/assets/js/243.bb476e73.js"><link rel="prefetch" href="/Roundtable/assets/js/244.24d6c58b.js"><link rel="prefetch" href="/Roundtable/assets/js/245.1ccbd137.js"><link rel="prefetch" href="/Roundtable/assets/js/246.df7d9449.js"><link rel="prefetch" href="/Roundtable/assets/js/247.660fe299.js"><link rel="prefetch" href="/Roundtable/assets/js/248.10cb80a3.js"><link rel="prefetch" href="/Roundtable/assets/js/249.eed5dc5e.js"><link rel="prefetch" href="/Roundtable/assets/js/25.17a60b3c.js"><link rel="prefetch" href="/Roundtable/assets/js/250.f288a89d.js"><link rel="prefetch" href="/Roundtable/assets/js/251.9dc81935.js"><link rel="prefetch" href="/Roundtable/assets/js/252.85530bdc.js"><link rel="prefetch" href="/Roundtable/assets/js/253.c5987f53.js"><link rel="prefetch" href="/Roundtable/assets/js/254.642bb309.js"><link rel="prefetch" href="/Roundtable/assets/js/255.dde65e9d.js"><link rel="prefetch" href="/Roundtable/assets/js/256.42b72968.js"><link rel="prefetch" href="/Roundtable/assets/js/257.983d1e31.js"><link rel="prefetch" href="/Roundtable/assets/js/258.2c57cdf5.js"><link rel="prefetch" href="/Roundtable/assets/js/259.7c6dbdcf.js"><link rel="prefetch" href="/Roundtable/assets/js/26.e245d43d.js"><link rel="prefetch" href="/Roundtable/assets/js/260.776a4c0e.js"><link rel="prefetch" href="/Roundtable/assets/js/261.b7c59dc5.js"><link rel="prefetch" href="/Roundtable/assets/js/262.147e3eda.js"><link rel="prefetch" href="/Roundtable/assets/js/263.f5e2fee0.js"><link rel="prefetch" href="/Roundtable/assets/js/264.708d2fd7.js"><link rel="prefetch" href="/Roundtable/assets/js/265.e92f4e6b.js"><link rel="prefetch" href="/Roundtable/assets/js/266.996eebcf.js"><link rel="prefetch" href="/Roundtable/assets/js/267.7195a488.js"><link rel="prefetch" href="/Roundtable/assets/js/268.44e38cbf.js"><link rel="prefetch" href="/Roundtable/assets/js/269.8ffd3512.js"><link rel="prefetch" href="/Roundtable/assets/js/27.949851ca.js"><link rel="prefetch" href="/Roundtable/assets/js/270.dd31add9.js"><link rel="prefetch" href="/Roundtable/assets/js/271.bcb8d475.js"><link rel="prefetch" href="/Roundtable/assets/js/272.b8da9de3.js"><link rel="prefetch" href="/Roundtable/assets/js/273.0219ced2.js"><link rel="prefetch" href="/Roundtable/assets/js/274.af61d3c7.js"><link rel="prefetch" href="/Roundtable/assets/js/275.5412975c.js"><link rel="prefetch" href="/Roundtable/assets/js/276.d61e471f.js"><link rel="prefetch" href="/Roundtable/assets/js/277.87ca63a0.js"><link rel="prefetch" href="/Roundtable/assets/js/278.3df4952e.js"><link rel="prefetch" href="/Roundtable/assets/js/279.bd547454.js"><link rel="prefetch" href="/Roundtable/assets/js/28.77287806.js"><link rel="prefetch" href="/Roundtable/assets/js/280.2abcb902.js"><link rel="prefetch" href="/Roundtable/assets/js/281.b15babf0.js"><link rel="prefetch" href="/Roundtable/assets/js/282.a1026c9f.js"><link rel="prefetch" href="/Roundtable/assets/js/283.1153e256.js"><link rel="prefetch" href="/Roundtable/assets/js/284.e5ffccb2.js"><link rel="prefetch" href="/Roundtable/assets/js/285.093448d3.js"><link rel="prefetch" href="/Roundtable/assets/js/286.a0a0cd00.js"><link rel="prefetch" href="/Roundtable/assets/js/287.a948b13e.js"><link rel="prefetch" href="/Roundtable/assets/js/288.79df6447.js"><link rel="prefetch" href="/Roundtable/assets/js/289.6f41ec0b.js"><link rel="prefetch" href="/Roundtable/assets/js/29.01548815.js"><link rel="prefetch" href="/Roundtable/assets/js/290.2e336aa3.js"><link rel="prefetch" href="/Roundtable/assets/js/291.fc886735.js"><link rel="prefetch" href="/Roundtable/assets/js/292.752ff5aa.js"><link rel="prefetch" href="/Roundtable/assets/js/293.02d2465d.js"><link rel="prefetch" href="/Roundtable/assets/js/294.18f7e9f8.js"><link rel="prefetch" href="/Roundtable/assets/js/295.454c891c.js"><link rel="prefetch" href="/Roundtable/assets/js/296.3adfc83c.js"><link rel="prefetch" href="/Roundtable/assets/js/297.d28ec585.js"><link rel="prefetch" href="/Roundtable/assets/js/298.df0e965c.js"><link rel="prefetch" href="/Roundtable/assets/js/299.28e754d0.js"><link rel="prefetch" href="/Roundtable/assets/js/30.73aac80a.js"><link rel="prefetch" href="/Roundtable/assets/js/300.72b2307a.js"><link rel="prefetch" href="/Roundtable/assets/js/301.3a4b7b5a.js"><link rel="prefetch" href="/Roundtable/assets/js/302.ea294ccc.js"><link rel="prefetch" href="/Roundtable/assets/js/303.9315e06b.js"><link rel="prefetch" href="/Roundtable/assets/js/304.49d60572.js"><link rel="prefetch" href="/Roundtable/assets/js/305.969fad20.js"><link rel="prefetch" href="/Roundtable/assets/js/306.2e6e6bd5.js"><link rel="prefetch" href="/Roundtable/assets/js/307.ea80271c.js"><link rel="prefetch" href="/Roundtable/assets/js/308.9b1ed249.js"><link rel="prefetch" href="/Roundtable/assets/js/309.f780fcea.js"><link rel="prefetch" href="/Roundtable/assets/js/31.233fa533.js"><link rel="prefetch" href="/Roundtable/assets/js/310.c65fbe43.js"><link rel="prefetch" href="/Roundtable/assets/js/311.5bbccaa1.js"><link rel="prefetch" href="/Roundtable/assets/js/312.2879b0b7.js"><link rel="prefetch" href="/Roundtable/assets/js/313.99d7c557.js"><link rel="prefetch" href="/Roundtable/assets/js/314.3c45e122.js"><link rel="prefetch" href="/Roundtable/assets/js/315.e90deb20.js"><link rel="prefetch" href="/Roundtable/assets/js/316.e40dd4f9.js"><link rel="prefetch" href="/Roundtable/assets/js/317.d271b499.js"><link rel="prefetch" href="/Roundtable/assets/js/318.244c1106.js"><link rel="prefetch" href="/Roundtable/assets/js/319.f76e550a.js"><link rel="prefetch" href="/Roundtable/assets/js/32.13bc3e83.js"><link rel="prefetch" href="/Roundtable/assets/js/320.6201d661.js"><link rel="prefetch" href="/Roundtable/assets/js/321.83daa393.js"><link rel="prefetch" href="/Roundtable/assets/js/322.48aaec2c.js"><link rel="prefetch" href="/Roundtable/assets/js/323.422c1a4c.js"><link rel="prefetch" href="/Roundtable/assets/js/324.28faac42.js"><link rel="prefetch" href="/Roundtable/assets/js/325.c58f5893.js"><link rel="prefetch" href="/Roundtable/assets/js/326.aa3c7342.js"><link rel="prefetch" href="/Roundtable/assets/js/327.d50dbf49.js"><link rel="prefetch" href="/Roundtable/assets/js/328.ba762f37.js"><link rel="prefetch" href="/Roundtable/assets/js/329.b26f992c.js"><link rel="prefetch" href="/Roundtable/assets/js/33.3cc42db3.js"><link rel="prefetch" href="/Roundtable/assets/js/330.88c8acf8.js"><link rel="prefetch" href="/Roundtable/assets/js/331.966b636b.js"><link rel="prefetch" href="/Roundtable/assets/js/332.66342b63.js"><link rel="prefetch" href="/Roundtable/assets/js/333.085ee3b7.js"><link rel="prefetch" href="/Roundtable/assets/js/34.b7f1e21a.js"><link rel="prefetch" href="/Roundtable/assets/js/35.f5b0ffef.js"><link rel="prefetch" href="/Roundtable/assets/js/36.4f1a3753.js"><link rel="prefetch" href="/Roundtable/assets/js/37.4bf027a3.js"><link rel="prefetch" href="/Roundtable/assets/js/38.fbdf2f41.js"><link rel="prefetch" href="/Roundtable/assets/js/39.ec7b84c4.js"><link rel="prefetch" href="/Roundtable/assets/js/4.05324643.js"><link rel="prefetch" href="/Roundtable/assets/js/40.8570da27.js"><link rel="prefetch" href="/Roundtable/assets/js/41.f7c69cef.js"><link rel="prefetch" href="/Roundtable/assets/js/42.dcc58233.js"><link rel="prefetch" href="/Roundtable/assets/js/43.2decb03b.js"><link rel="prefetch" href="/Roundtable/assets/js/44.879a85b2.js"><link rel="prefetch" href="/Roundtable/assets/js/45.5069e7a9.js"><link rel="prefetch" href="/Roundtable/assets/js/46.f202c415.js"><link rel="prefetch" href="/Roundtable/assets/js/47.6037b8b6.js"><link rel="prefetch" href="/Roundtable/assets/js/48.37326281.js"><link rel="prefetch" href="/Roundtable/assets/js/49.2013781d.js"><link rel="prefetch" href="/Roundtable/assets/js/5.f0189c4a.js"><link rel="prefetch" href="/Roundtable/assets/js/50.0f540bc5.js"><link rel="prefetch" href="/Roundtable/assets/js/51.984ee8f6.js"><link rel="prefetch" href="/Roundtable/assets/js/52.3ebe0570.js"><link rel="prefetch" href="/Roundtable/assets/js/53.5b787040.js"><link rel="prefetch" href="/Roundtable/assets/js/54.1d500b04.js"><link rel="prefetch" href="/Roundtable/assets/js/55.cd8fb562.js"><link rel="prefetch" href="/Roundtable/assets/js/56.9ed2ca10.js"><link rel="prefetch" href="/Roundtable/assets/js/57.019b4018.js"><link rel="prefetch" href="/Roundtable/assets/js/58.83f30aa3.js"><link rel="prefetch" href="/Roundtable/assets/js/59.953c383a.js"><link rel="prefetch" href="/Roundtable/assets/js/6.8f8bc88b.js"><link rel="prefetch" href="/Roundtable/assets/js/60.674f791e.js"><link rel="prefetch" href="/Roundtable/assets/js/61.cfbfaacb.js"><link rel="prefetch" href="/Roundtable/assets/js/62.fc95f668.js"><link rel="prefetch" href="/Roundtable/assets/js/63.ea208038.js"><link rel="prefetch" href="/Roundtable/assets/js/64.5e134a18.js"><link rel="prefetch" href="/Roundtable/assets/js/65.9e1d4f36.js"><link rel="prefetch" href="/Roundtable/assets/js/66.f3525daf.js"><link rel="prefetch" href="/Roundtable/assets/js/67.bde24de9.js"><link rel="prefetch" href="/Roundtable/assets/js/68.6628f2ec.js"><link rel="prefetch" href="/Roundtable/assets/js/69.5d37a9a0.js"><link rel="prefetch" href="/Roundtable/assets/js/7.17464b33.js"><link rel="prefetch" href="/Roundtable/assets/js/70.8fc6ad5f.js"><link rel="prefetch" href="/Roundtable/assets/js/71.2cf28266.js"><link rel="prefetch" href="/Roundtable/assets/js/72.6685a0e9.js"><link rel="prefetch" href="/Roundtable/assets/js/73.87f81e2e.js"><link rel="prefetch" href="/Roundtable/assets/js/74.e83a7acb.js"><link rel="prefetch" href="/Roundtable/assets/js/76.0afa4c8e.js"><link rel="prefetch" href="/Roundtable/assets/js/77.fb66bb2c.js"><link rel="prefetch" href="/Roundtable/assets/js/78.c7ac5773.js"><link rel="prefetch" href="/Roundtable/assets/js/79.54eedab8.js"><link rel="prefetch" href="/Roundtable/assets/js/8.ec06db61.js"><link rel="prefetch" href="/Roundtable/assets/js/80.4bd0c664.js"><link rel="prefetch" href="/Roundtable/assets/js/81.7a5d3e8c.js"><link rel="prefetch" href="/Roundtable/assets/js/82.6afcf639.js"><link rel="prefetch" href="/Roundtable/assets/js/83.974782a6.js"><link rel="prefetch" href="/Roundtable/assets/js/84.ede7853d.js"><link rel="prefetch" href="/Roundtable/assets/js/85.2795805d.js"><link rel="prefetch" href="/Roundtable/assets/js/86.a4840136.js"><link rel="prefetch" href="/Roundtable/assets/js/87.f9e5b890.js"><link rel="prefetch" href="/Roundtable/assets/js/88.0652dba1.js"><link rel="prefetch" href="/Roundtable/assets/js/89.544a3b4e.js"><link rel="prefetch" href="/Roundtable/assets/js/9.8d8fe1f7.js"><link rel="prefetch" href="/Roundtable/assets/js/90.db1243a6.js"><link rel="prefetch" href="/Roundtable/assets/js/91.254b918c.js"><link rel="prefetch" href="/Roundtable/assets/js/92.3a31f1ff.js"><link rel="prefetch" href="/Roundtable/assets/js/93.28e6e2d6.js"><link rel="prefetch" href="/Roundtable/assets/js/94.a0bf808a.js"><link rel="prefetch" href="/Roundtable/assets/js/95.29c29bb4.js"><link rel="prefetch" href="/Roundtable/assets/js/96.bd6353b2.js"><link rel="prefetch" href="/Roundtable/assets/js/97.10daec76.js"><link rel="prefetch" href="/Roundtable/assets/js/98.c067eeb9.js"><link rel="prefetch" href="/Roundtable/assets/js/99.b7267739.js"><link rel="prefetch" href="/Roundtable/assets/js/vendors~docsearch.cbbc0be1.js">
    <link rel="stylesheet" href="/Roundtable/assets/css/0.styles.473b2e6f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Roundtable/" class="home-link router-link-active"><img src="/Roundtable/logo.png" alt="Roundtable Coders" class="logo"> <span class="site-name can-hide">Roundtable Coders</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><a href="/Roundtable/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/Roundtable/Question-Bank/" class="nav-link router-link-active">
  知识库
</a></div><div class="nav-item"><a href="/Roundtable/Lets-Read/" class="nav-link">
  共读
</a></div><div class="nav-item"><a href="/Roundtable/Wanted/" class="nav-link">
  通缉令
</a></div><div class="nav-item"><a href="/Roundtable/Quest-SC/" class="nav-link">
  源码探秘
</a></div><div class="nav-item"><a href="/Roundtable/Algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="https://esop-fed.github.io/ani-css/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Ani-Css
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/Roundtable/Replay/" class="nav-link">
  项目复盘
</a></div><div class="nav-item"><a href="/Roundtable/FullStackDeveloper/" class="nav-link">
  进阶全栈
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="个人备忘" class="dropdown-title"><span class="title">个人备忘</span> <span class="arrow down"></span></button> <button type="button" aria-label="个人备忘" class="mobile-dropdown-title"><span class="title">个人备忘</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Roundtable/Mark/johninch/" class="nav-link">
  johninch
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="blog" class="dropdown-title"><span class="title">blog</span> <span class="arrow down"></span></button> <button type="button" aria-label="blog" class="mobile-dropdown-title"><span class="title">blog</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://johninch.github.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  johninch
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://dannisi.github.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Caleb
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://niannings.github.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  niannings
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://Xmtd.github.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Xmtd
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://febcat.github.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  febcat
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="github" class="dropdown-title"><span class="title">github</span> <span class="arrow down"></span></button> <button type="button" aria-label="github" class="mobile-dropdown-title"><span class="title">github</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/johninch/Roundtable" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Roundtable
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/esop-fed" target="_blank" rel="noopener noreferrer" class="nav-link external">
  esop-fed
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/johninch" target="_blank" rel="noopener noreferrer" class="nav-link external">
  johninch
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/dannisi" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Caleb
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/niannings" target="_blank" rel="noopener noreferrer" class="nav-link external">
  niannings
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/Xmtd" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Xmtd
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/febcat" target="_blank" rel="noopener noreferrer" class="nav-link external">
  febcat
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/Roundtable/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/Roundtable/Question-Bank/" class="nav-link router-link-active">
  知识库
</a></div><div class="nav-item"><a href="/Roundtable/Lets-Read/" class="nav-link">
  共读
</a></div><div class="nav-item"><a href="/Roundtable/Wanted/" class="nav-link">
  通缉令
</a></div><div class="nav-item"><a href="/Roundtable/Quest-SC/" class="nav-link">
  源码探秘
</a></div><div class="nav-item"><a href="/Roundtable/Algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="https://esop-fed.github.io/ani-css/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Ani-Css
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/Roundtable/Replay/" class="nav-link">
  项目复盘
</a></div><div class="nav-item"><a href="/Roundtable/FullStackDeveloper/" class="nav-link">
  进阶全栈
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="个人备忘" class="dropdown-title"><span class="title">个人备忘</span> <span class="arrow down"></span></button> <button type="button" aria-label="个人备忘" class="mobile-dropdown-title"><span class="title">个人备忘</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Roundtable/Mark/johninch/" class="nav-link">
  johninch
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="blog" class="dropdown-title"><span class="title">blog</span> <span class="arrow down"></span></button> <button type="button" aria-label="blog" class="mobile-dropdown-title"><span class="title">blog</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://johninch.github.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  johninch
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://dannisi.github.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Caleb
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://niannings.github.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  niannings
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://Xmtd.github.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Xmtd
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://febcat.github.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  febcat
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="github" class="dropdown-title"><span class="title">github</span> <span class="arrow down"></span></button> <button type="button" aria-label="github" class="mobile-dropdown-title"><span class="title">github</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/johninch/Roundtable" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Roundtable
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/esop-fed" target="_blank" rel="noopener noreferrer" class="nav-link external">
  esop-fed
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/johninch" target="_blank" rel="noopener noreferrer" class="nav-link external">
  johninch
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/dannisi" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Caleb
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/niannings" target="_blank" rel="noopener noreferrer" class="nav-link external">
  niannings
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/Xmtd" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Xmtd
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/febcat" target="_blank" rel="noopener noreferrer" class="nav-link external">
  febcat
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/Roundtable/Question-Bank/" aria-current="page" class="sidebar-link">知识库 Question-Bank</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基本语法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>面向对象与原型链</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JS的执行机制</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CSS相关</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTML &amp; DOM</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>BOM</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>通信</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>浏览器及前端性能</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>网络安全</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>正则表达式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>工程化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ES6+</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>TypeScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MVVM</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>React</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>小程序</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Nodejs</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Roundtable/Question-Bank/nodejs/nodejs-base.html" class="sidebar-link">nodejs 基础</a></li><li><a href="/Roundtable/Question-Bank/nodejs/bff.html" class="sidebar-link">BFF 中间层</a></li><li><a href="/Roundtable/Question-Bank/nodejs/rpc.html" class="sidebar-link">RPC 远程过程调用</a></li><li><a href="/Roundtable/Question-Bank/nodejs/rpc-serialize.html" class="sidebar-link">RPC 序列化</a></li><li><a href="/Roundtable/Question-Bank/nodejs/thrift-demo.html" class="sidebar-link">Thrift 上手指南</a></li><li><a href="/Roundtable/Question-Bank/nodejs/service-discovery.html" class="sidebar-link">Service Discovery 服务发现</a></li><li><a href="/Roundtable/Question-Bank/nodejs/benchmarking-tool.html" class="sidebar-link">压测工具简单实践</a></li><li><a href="/Roundtable/Question-Bank/nodejs/nodejs-myblog-imooc.html" aria-current="page" class="active sidebar-link">慕课实战：Node.js 从零开发 web server博客项目 前端晋升全栈工程师必备</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Roundtable/Question-Bank/nodejs/nodejs-myblog-imooc.html#困惑" class="sidebar-link">困惑</a></li><li class="sidebar-sub-header"><a href="/Roundtable/Question-Bank/nodejs/nodejs-myblog-imooc.html#目标-不用任何框架" class="sidebar-link">目标（不用任何框架）</a></li><li class="sidebar-sub-header"><a href="/Roundtable/Question-Bank/nodejs/nodejs-myblog-imooc.html#第七章-日志-原生实现" class="sidebar-link">第七章 - 日志（原生实现）</a></li><li class="sidebar-sub-header"><a href="/Roundtable/Question-Bank/nodejs/nodejs-myblog-imooc.html#第八章-安全-原生实现" class="sidebar-link">第八章 - 安全（原生实现）</a></li><li class="sidebar-sub-header"><a href="/Roundtable/Question-Bank/nodejs/nodejs-myblog-imooc.html#第九章-使用express重构" class="sidebar-link">第九章 - 使用express重构</a></li><li class="sidebar-sub-header"><a href="/Roundtable/Question-Bank/nodejs/nodejs-myblog-imooc.html#第十章-使用koa2重构" class="sidebar-link">第十章 - 使用koa2重构</a></li><li class="sidebar-sub-header"><a href="/Roundtable/Question-Bank/nodejs/nodejs-myblog-imooc.html#第十一章-线上环境配置" class="sidebar-link">第十一章 线上环境配置</a></li></ul></li><li><a href="/Roundtable/Question-Bank/nodejs/eventEmitter.html" class="sidebar-link">EventEmitter实现</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>包管理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Webpack</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Git</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>工作实践</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>PWA</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>了解后端</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>运维相关</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="慕课实战-node-js-从零开发-web-server博客项目-前端晋升全栈工程师必备"><a href="#慕课实战-node-js-从零开发-web-server博客项目-前端晋升全栈工程师必备" class="header-anchor">#</a> 慕课实战：Node.js 从零开发 web server博客项目 前端晋升全栈工程师必备</h1> <p>Nodejs 一个js运行环境</p> <p>运行在服务器，作为web server</p> <p>运行在本地，作为打包、构建工具</p> <h2 id="困惑"><a href="#困惑" class="header-anchor">#</a> 困惑</h2> <p>Nodejs运行在服务端，不在浏览器</p> <p>前端和服务端套路不同</p> <p>做什么？</p> <ul><li>nodejs入门到实战，开发个人博客系统</li></ul> <p>哪些部分？</p> <ul><li>API、数据存储、登录、日志、安全</li></ul> <p>技术？</p> <ul><li>http、stream、session、mysql、redis、nginx、pm2...</li></ul> <p>原生实现：</p> <ul><li>API和数据存储</li> <li>登录和redis</li> <li>安全和日志</li></ul> <p>使用框架：</p> <ul><li>express</li> <li>koa2</li> <li>中间件和插件</li> <li>中间件原理</li></ul> <p>线上环境：</p> <ul><li>pm2介绍和配置</li> <li>pm2多进程模型</li> <li>服务端运维</li></ul> <h3 id="课程准备"><a href="#课程准备" class="header-anchor">#</a> 课程准备</h3> <ul><li>nodejs和js的区别</li> <li>服务端特点，服务端和前端的区别</li> <li>博客项目的需求分析和技术方案设计</li></ul> <h4 id="下载安装"><a href="#下载安装" class="header-anchor">#</a> 下载安装</h4> <p>使用nvm：brew install nvm</p> <h4 id="nodejs和js的区别"><a href="#nodejs和js的区别" class="header-anchor">#</a> nodejs和js的区别</h4> <ul><li><p>ES只是一种语法规范，定义了语法。写js和nodejs都必须遵守的，包括变量定义，循环，判断，函数，原型原型链，作用域和闭包，异步。</p></li> <li><p>但ES不能操作DOM，不能监听click事件，不能发送ajax请求；不能处理http请求，不能操作文件。</p></li> <li><p>而JS是使用了ES的语法规范，外加 Web API，二者缺一不可，相互结合才可完成浏览器端的所有操作。</p></li> <li><p>JS = ES + Web API</p></li> <li><p>Web API：DOM操作，BOM操作，事件绑定，Ajax等。。</p></li> <li><p>而nodejs是使用了ES的语法规范，外加 nodejs API，二者缺一不可，相互结合才可完成服务器端的所有操作。</p></li> <li><p>nodejs = ES + nodejs API</p></li> <li><p>nodejs API：处理http，处理文件等。。</p></li></ul> <h4 id="commonjs模块化"><a href="#commonjs模块化" class="header-anchor">#</a> commonjs模块化</h4> <h4 id="nodejs-debugger-vscode"><a href="#nodejs-debugger-vscode" class="header-anchor">#</a> nodejs debugger（vscode）</h4> <h4 id="server开发和前端开发的区别"><a href="#server开发和前端开发的区别" class="header-anchor">#</a> server开发和前端开发的区别</h4> <ul><li><p>服务稳定性</p> <ul><li>server端可能会遭受各种恶意攻击和误操作</li> <li>单个客户端可以以外挂掉，但是服务端不能</li> <li>解决：使用pm2做进程守候</li></ul></li> <li><p>考虑内存和CPU（优化，扩展）</p> <ul><li>客户端独占一个浏览器，内存和CPU都不是问题</li> <li>server端要承载很多请求，CPU和内存都是稀缺资源</li> <li>解决：使用stream写日志（节省CPU和内存），使用redis存session</li></ul></li> <li><p>日志记录</p> <ul><li>前端也会参与写日志，但只是日志的发起方，不关系后续</li> <li>server端要记录日志、存储日志、分析日志，前端不关心</li> <li>解决：多种日志记录方式，及如何分析日志</li></ul></li> <li><p>安全</p> <ul><li>server端随时准备接收各种恶意攻击，前端则少很多</li> <li>如 越权操作，数据库攻击等</li> <li>解决：讲解登录验证，预防xss攻击和sql注入</li></ul></li> <li><p>集群和服务拆分</p> <ul><li>产品发展速度快，流量可能会迅速增加</li> <li>如何通过扩展机器和服务拆分来承载大流量</li> <li>解决：</li></ul></li></ul> <h2 id="目标-不用任何框架"><a href="#目标-不用任何框架" class="header-anchor">#</a> 目标（不用任何框架）</h2> <ul><li><p>开发一个博客系统，具有博客的基本功能</p></li> <li><p>值开发server端，不关心前端</p></li> <li><p>需求</p> <ul><li>首页</li> <li>作者主页</li> <li>博客详情页</li></ul></li> <li><p>登录页</p></li> <li><p>管理中心</p> <ul><li>新建页</li> <li>编辑页</li></ul></li></ul> <h3 id="开发接口-不用任何框架"><a href="#开发接口-不用任何框架" class="header-anchor">#</a> 开发接口（不用任何框架）</h3> <p>nodejs处理http请求</p> <p>搭建开发环境</p> <p>开发接口（暂时不连接数据库，暂不考虑登录）</p> <h3 id="搭建开发环境"><a href="#搭建开发环境" class="header-anchor">#</a> 搭建开发环境</h3> <p>使用nodemon监测文件变化，自动重启node</p> <p>拆分成4层：</p> <ul><li><ol><li>bin/wwww.js：执行server的设置，createServer，port，listen</li></ol></li> <li><ol start="2"><li>app.js：只是应用基本设置的聚集地，设置返回类型，获取path，解析query，处理路由，处理404，涉及不到业务代码</li></ol></li> <li><ol start="3"><li>src/router：只处理路由，匹配相关路由返回数据格式</li></ol></li> <li><ol start="4"><li>src/controller：只关心数据，筛选处理</li></ol></li></ul> <p>接口开发（假数据）</p> <h3 id="数据存储-连数据库"><a href="#数据存储-连数据库" class="header-anchor">#</a> 数据存储（连数据库）</h3> <p>Q：为何用mysql而不是mogondb？</p> <ul><li>mysql是且业内最常用的存储工具，一般都有专人运维</li> <li>mysql也是社区内最常用的存储工具</li> <li>web server中最流行的关系型数据库</li></ul> <h4 id="操作数据库"><a href="#操作数据库" class="header-anchor">#</a> 操作数据库</h4> <ul><li>建库
<ul><li>创建</li> <li>show Databases</li></ul></li> <li>建表
<ul><li>常用类型
<ul><li>int</li> <li>bigint</li> <li>varchar</li> <li>longtext</li></ul></li></ul></li> <li>表操作
<ul><li>sql实现增删改查</li></ul> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> version<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">-- 查询版本</span>

<span class="token keyword">use</span> myblog<span class="token punctuation">;</span> <span class="token comment">-- 使用某个库</span>

<span class="token keyword">show</span> <span class="token keyword">tables</span><span class="token punctuation">;</span> <span class="token comment">-- 显示所有表</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> users <span class="token punctuation">(</span>username<span class="token punctuation">,</span> <span class="token punctuation">`</span>password<span class="token punctuation">`</span><span class="token punctuation">,</span> realname<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'zhangsan'</span><span class="token punctuation">,</span><span class="token string">'123'</span><span class="token punctuation">,</span><span class="token string">'张三'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">-- 减减 用来注释</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> users <span class="token punctuation">(</span>username<span class="token punctuation">,</span> <span class="token punctuation">`</span>password<span class="token punctuation">`</span><span class="token punctuation">,</span> realname<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'lisi'</span><span class="token punctuation">,</span><span class="token string">'123'</span><span class="token punctuation">,</span><span class="token string">'李四'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">-- password是sql保留字段，需要反斜杠包裹</span>

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> users<span class="token punctuation">;</span> <span class="token comment">-- 实际使用中，要避免全量查找</span>
<span class="token keyword">select</span> id<span class="token punctuation">,</span> username <span class="token keyword">from</span> users<span class="token punctuation">;</span>

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> users <span class="token keyword">where</span> username<span class="token operator">=</span><span class="token string">'zhangsan'</span> <span class="token operator">and</span> password<span class="token operator">=</span><span class="token string">'123'</span><span class="token punctuation">;</span> <span class="token comment">-- 取交集</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> users <span class="token keyword">where</span> username<span class="token operator">=</span><span class="token string">'zhangsan'</span> <span class="token operator">or</span> password<span class="token operator">=</span><span class="token string">'123'</span><span class="token punctuation">;</span> <span class="token comment">-- 取并集</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> users <span class="token keyword">where</span> username <span class="token operator">like</span> <span class="token string">'%zhang%'</span><span class="token punctuation">;</span> <span class="token comment">-- 模糊匹配</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> users <span class="token keyword">where</span> password <span class="token operator">like</span> <span class="token string">'%1%'</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> users <span class="token keyword">where</span> password <span class="token operator">like</span> <span class="token string">'%1%'</span> <span class="token keyword">order</span> <span class="token keyword">by</span> id<span class="token punctuation">;</span> <span class="token comment">-- 升序排序</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> users <span class="token keyword">where</span> password <span class="token operator">like</span> <span class="token string">'%1%'</span> <span class="token keyword">order</span> <span class="token keyword">by</span> id <span class="token keyword">desc</span><span class="token punctuation">;</span> <span class="token comment">-- 降序排序</span>

<span class="token keyword">SET</span> SQL_SAFE_UPDATES<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">-- 设置是否可安全更新，否则更新和删除操作不能成功执行</span>

<span class="token keyword">update</span> users <span class="token keyword">set</span> realname<span class="token operator">=</span><span class="token string">'李四2'</span> <span class="token keyword">where</span> username<span class="token operator">=</span><span class="token string">'lisi'</span><span class="token punctuation">;</span>

<span class="token keyword">delete</span> <span class="token keyword">from</span> users <span class="token keyword">where</span> username<span class="token operator">=</span><span class="token string">'lisi'</span><span class="token punctuation">;</span> <span class="token comment">-- 实际工作中不直接使用delete删除</span>
<span class="token keyword">update</span> users <span class="token keyword">set</span> state<span class="token operator">=</span><span class="token string">'0'</span> <span class="token keyword">where</span> username<span class="token operator">=</span><span class="token string">'lisi'</span><span class="token punctuation">;</span> <span class="token comment">-- 软删除，通过增加一个state列，1代表可用，0代表不可用，设置为0即为删除</span>

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> users <span class="token keyword">where</span> state <span class="token operator">&lt;&gt;</span> <span class="token number">0</span> <span class="token comment">-- &lt;&gt;表示不等于</span>
</code></pre></div></li></ul> <h4 id="nodejs操作mysql"><a href="#nodejs操作mysql" class="header-anchor">#</a> nodejs操作mysql</h4> <p>nodejs链接mysql，如何执行sql语句</p> <p>根据NODE_ENV区分配置</p> <p>封装exec函数，API使用exec操作数据库</p> <p>不使用框架来做nodejs操作数据库，分为好多层：</p> <h3 id="登录"><a href="#登录" class="header-anchor">#</a> 登录</h3> <ul><li>核心：登录校验 &amp; 登录信息存储</li> <li>为何只讲登录，不讲注册？</li></ul> <p>目录</p> <ul><li>cookie 和 session</li> <li>session 写入 redis</li> <li>开发登录功能，和前端联调（用nginx反向代理）</li></ul> <h3 id="cookie"><a href="#cookie" class="header-anchor">#</a> cookie</h3> <ul><li>什么是cookie
<ul><li>存储在浏览器中的一段字符串（最大5kb）</li> <li>跨域不共享</li> <li>格式如 k1=v1;k2=v2;k3=v3；因此可以存储结构化数据</li> <li>每次发送http请求，会将请求域的cookie一起发送给server</li> <li>server可以修改cookie并通过http response返回给浏览器</li> <li>浏览器中也可以通过js修改cookie（有限制）</li></ul></li> <li>浏览器中查看cookie（3种方式）
<ul><li>js查看，修改cookie（有限制）
<ul><li>http请求头和响应头</li> <li>application中查看</li> <li>document.cookie</li></ul></li></ul></li> <li>server端nodejs操作cookie，实现登录验证</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 获取 cookie 的过期时间</span>
<span class="token keyword">const</span> <span class="token function-variable function">getCookieExpires</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> d <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    d<span class="token punctuation">.</span><span class="token function">setTime</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> d<span class="token punctuation">.</span><span class="token function">toGMTString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 操作cookie</span>
<span class="token comment">// cookie生效路由要设为根路由</span>
<span class="token comment">// cookie 要设置httpOnly，防止客户端操作更改</span>
res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Set-Cookie'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">username=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>username<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">; path=/; httpOnly; expires=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">getCookieExpires</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
</code></pre></div><h3 id="session"><a href="#session" class="header-anchor">#</a> session</h3> <ul><li>上一节的问题：会暴露username，很危险</li> <li>如何解决：cookie中存储userId，server端对应username</li> <li>解决方案：session，即server端存储用户信息
<ul><li>设置session方式的问题
<ul><li>目前session直接是js变量，放在nodejs进程内存中（即放在web server中）</li> <li>1、进程内存有限，访问量过大，内存暴增崩掉怎么办</li> <li>2、正式线上运行是多进程的，进程之间内存无法共享
<ul><li>（多机器，多机房与多进程是一样的，同样内存无法共享）</li></ul></li> <li>解决方案：redis内存数据库
<ul><li>什么是redis
<ul><li>web server 最常用的缓存数据库，数据存放在内存中</li> <li>相比于mysql，访问速度快（内存和硬盘不是一个数量级的）</li> <li>但是成本更高，可存储的数据量更小（内存的硬伤）</li></ul></li> <li>解决方案：
<ul><li>将web server和redis拆分为两个单独的服务</li> <li>双方都是独立的，都是可扩展的（例如都可以扩展成集群）</li> <li>（包括mysql，也是一个单独的服务，也可扩展）</li></ul></li> <li>为何session适用redis？
<ul><li>session访问频繁，对性能要求极高</li> <li>session可不考虑断电丢失数据的问题（内存的硬伤）
<ul><li>另外，redis经过特定配置后也能断电不丢失数据</li></ul></li> <li>session数据量不会太大（相比于mysql中存储的数据）</li></ul></li> <li>为何网站数据需要存在mysql，而不适合用redis？
<ul><li>操作频率不是太高（相比于session操作）</li> <li>断电不能丢失，必须保留</li> <li>数据量太大，内存成本太高</li></ul></li></ul></li></ul></li></ul></li></ul> <h3 id="redis使用"><a href="#redis使用" class="header-anchor">#</a> Redis使用</h3> <div class="language-js extra-class"><pre class="language-js"><code>brew install redis <span class="token comment">// mac使用homebrew安装</span>

redis<span class="token operator">-</span>cli <span class="token comment">// 开启redis数据库命令行工具</span>

redis<span class="token operator">-</span>server <span class="token comment">// 启动redis服务器</span>
</code></pre></div><ul><li>nodejs连接redis的demo</li> <li>封装成工具函数，可供API使用</li></ul> <h3 id="登录校验"><a href="#登录校验" class="header-anchor">#</a> 登录校验</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 统一的登录验证函数</span>
<span class="token keyword">const</span> <span class="token function-variable function">loginCheck</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>username<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ErrorModel</span><span class="token punctuation">(</span><span class="token string">'尚未登录'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> loginCheckResult <span class="token operator">=</span> <span class="token function">loginCheck</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>loginCheckResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 未登录</span>
    <span class="token keyword">return</span> loginCheckResult
<span class="token punctuation">}</span>
</code></pre></div><h3 id="和前端联调"><a href="#和前端联调" class="header-anchor">#</a> 和前端联调</h3> <ul><li>post请求，登录功能依赖cookie，所以不能用postman来联调，必须用浏览器</li> <li>cookie跨域不共享，前端和server端必须同域
<ul><li>需要用到nginx做代理，让前后端同域</li> <li>后端是localhost:8000</li> <li>前端是localhost:8001（<code>$ http-server -p 8001</code>）</li> <li>使用nginx配置反向代理，localhost:8080</li></ul></li></ul> <h3 id="nginx配置"><a href="#nginx配置" class="header-anchor">#</a> nginx配置</h3> <ul><li>高性能的web服务器，开源免费</li> <li>一般用于做静态服务，负载均衡</li> <li>反向代理</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>brew install nginx <span class="token comment">// mac使用homebrew安装</span>

<span class="token comment">// win: c:\nginx\conf\nginx.conf</span>
<span class="token comment">// mac: /usr/local/etc/nginx/nginx.conf</span>

<span class="token comment">// 测试配置文件格式是否正确 nginx -t</span>
<span class="token comment">// 启动 nginx</span>
<span class="token comment">// 重启 nginx -s reload</span>
<span class="token comment">// 停止 nginx -s stop</span>

<span class="token comment">// location / {</span>
<span class="token comment">//   proxy_pass http://localhost:8001;</span>
<span class="token comment">// }</span>
<span class="token comment">// location /api/ {</span>
<span class="token comment">//   proxy_pass http://localhost:8000;</span>
<span class="token comment">//   proxy_set_header Host $host;</span>
<span class="token comment">// }</span>
</code></pre></div><h2 id="第七章-日志-原生实现"><a href="#第七章-日志-原生实现" class="header-anchor">#</a> 第七章 - 日志（原生实现）</h2> <ul><li><p>日志重要性及分类</p> <ul><li>系统没有日志，就等于人没有眼睛 —— 抓瞎
<ul><li>qps（query per second 每秒访问量）是多少</li></ul></li> <li>访问日志 access log（server端最重要的日志）</li> <li>自定义日志（包括自定义事件、错误记录等）</li></ul></li> <li><p>本章目录</p> <ul><li>日志放在文件中，<code>nodejs文件操作</code>，nodejs stream</li> <li>日志内容开发和使用</li> <li>日志文件拆分，日志内容分析</li></ul></li> <li><p>问题</p> <ul><li>日志要存储在文件中
<ul><li>为什么不存储到mysql中？
<ul><li>mysql是存储表结构的，而日志只是文本，没有结构，且日志作为文件可以拷贝到任何系统中</li> <li>mysql虽然和文件都是硬盘，但mysql使用了b树，访问很快，而日志只需要异步写到文件中即可</li></ul></li> <li>为什么不存储到redis中？
<ul><li>redis是内存，访问最快，但因为日志很大，成本就太大了</li> <li>日志的访问对速度要求也并不高，虽然文件访问相对是最慢的，但没关系</li></ul></li></ul></li></ul></li></ul> <h3 id="nodejs基本文件操作"><a href="#nodejs基本文件操作" class="header-anchor">#</a> nodejs基本文件操作</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// path.resolve 拼接目录</span>
<span class="token comment">// __dirname 当前目录</span>
<span class="token keyword">const</span> fileName <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'data.txt'</span><span class="token punctuation">)</span>

<span class="token comment">// 1. 读取文件内容</span>
fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// data 是二进制类型，需要转换为字符串</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 这里的data如果很大，比如有3个G怎么办</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 2. 写入文件</span>
<span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token string">'这是新写入的内容\n'</span>

<span class="token keyword">const</span> opt <span class="token operator">=</span> <span class="token punctuation">{</span>
    flag<span class="token operator">:</span> <span class="token string">'a'</span> <span class="token comment">// 追加写入。覆盖用 ‘w’</span>
<span class="token punctuation">}</span>

fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> content<span class="token punctuation">,</span> opt<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 每次执行写入操作，也是很耗费内存的，而且如果content很大的话，进程的内存也会崩掉</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'写入成功'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 3. 判断文件是否存在</span>
fs<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">exists</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 判断操作也是 异步 的</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'exists '</span><span class="token punctuation">,</span>exists<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="stream"><a href="#stream" class="header-anchor">#</a> Stream</h3> <p>IO操作的性能瓶颈</p> <ul><li>IO包括 “网络IO” 和 “文件IO”</li> <li>相比于CPU计算和内存读写，IO的突出特点就是 “慢”</li> <li>如何在有限的硬件资源下提高IO的操作效率？
<ul><li>使用 stream 提高性能</li> <li>nodejs如何操作</li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 标准输入输出，pipe就是管道（符合水流管道的模型图）</span>
<span class="token comment">// process.stdin（即source） 获取数据，直接通过管道（即pipe），传递给 process.stdout（即dest）</span>
process<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span>
</code></pre></div><p>如下的req.on中的data就是网络IO的数据stream，每传一点就触发on data接收一点，每传一点就触发on data接收一点：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 处理post请求</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'POST'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'content-type :'</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'content-type'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token keyword">let</span> postData <span class="token operator">=</span> <span class="token string">''</span>
        <span class="token comment">// 像一个水管一样，监听data的流动，每次获取一部分chunk</span>
        req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token parameter">chunk</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            postData <span class="token operator">+=</span> chunk<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment">// 监听data流动结束</span>
        req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'postData :'</span><span class="token punctuation">,</span> postData<span class="token punctuation">)</span>
            res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'hello world'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'POST'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        req<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token comment">// req 和 res 都具有 stream的一些特性</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span>
</code></pre></div><p>使用stream的方式操作文件</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 实现拷贝功能</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> fileName1 <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'data.txt'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fileName2 <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'data-bak.txt'</span><span class="token punctuation">)</span>

<span class="token comment">// 读取文件的 stream 对象</span>
<span class="token keyword">const</span> readStream <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>fileName1<span class="token punctuation">)</span>
<span class="token comment">// 写入文件的 stream 对象</span>
<span class="token keyword">const</span> writeStream <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span>fileName2<span class="token punctuation">)</span>

<span class="token comment">// 通过 pipe 拷贝</span>
readStream<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>writeStream<span class="token punctuation">)</span>

<span class="token comment">// 也可以监听每次读取的内容</span>
readStream<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token parameter">chunk</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 比如可以找个10M的文件看一下，这里读取输出在控制台就是一点点完成的</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

readStream<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'拷贝完成'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 通过网络请求读取文件内容</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> method <span class="token operator">=</span> req<span class="token punctuation">.</span>method
    <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'GET'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> fileName <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'data.txt'</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> stream <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span> <span class="token comment">// 文件IO</span>

        stream<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token comment">// 将 res 作为 stream 的dest，网络IO</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="写日志"><a href="#写日志" class="header-anchor">#</a> 写日志</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 写日志</span>
<span class="token keyword">function</span> <span class="token function">writeLog</span><span class="token punctuation">(</span><span class="token parameter">writeStream<span class="token punctuation">,</span> log</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    writeStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>log <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 生成 write stream</span>
<span class="token keyword">function</span> <span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token parameter">fileName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> fullFileName <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../'</span><span class="token punctuation">,</span> <span class="token string">'../'</span><span class="token punctuation">,</span> <span class="token string">'logs'</span><span class="token punctuation">,</span> fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> writeStream <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span>fullFileName<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        flags<span class="token operator">:</span> <span class="token string">'a'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> writeStream<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> accessWriteStream <span class="token operator">=</span> <span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token string">'access.log'</span><span class="token punctuation">)</span>
<span class="token keyword">function</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token parameter">log</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">writeLog</span><span class="token punctuation">(</span>accessWriteStream<span class="token punctuation">,</span> log<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    access
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">serverHandle</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 记录 access log</span>
    <span class="token function">access</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> -- </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> -- </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'user-agent'</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> -- </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>

    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="拆分日志-使用crontab"><a href="#拆分日志-使用crontab" class="header-anchor">#</a> 拆分日志 - 使用<code>crontab</code></h3> <ul><li>日志内容会慢慢积累，放在一个文件中不好处理</li> <li>按时间划分日志文件，如2019-02-10.access.log</li> <li>实现方式：linux的crontab命令，即定时任务</li></ul> <h4 id="crontab"><a href="#crontab" class="header-anchor">#</a> <code>crontab</code></h4> <p>设置<strong>定时任务</strong>，格式：<code>*****command</code>，星号依次是 分钟、小时、日期、月份、星期，command是shell命令</p> <ul><li>比如，21*** command 每天的第1个小时的第2分钟去执行command的命令</li> <li>将access.log 拷贝并重命名为2019-02-10.access.log</li> <li>清空access.log文件，继续积累日志</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>sh copy<span class="token punctuation">.</span>sh
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 命令行进入crontab任务编辑器</span>
$ crontab <span class="token operator">-</span>e

<span class="token comment">// 输入并保存，每天0点执行日志拆分</span>
<span class="token operator">*</span> <span class="token number">0</span> <span class="token operator">*</span> <span class="token operator">*</span> <span class="token operator">*</span> sh <span class="token operator">/</span>Users<span class="token operator">/</span>johninch<span class="token operator">/</span>workspace<span class="token operator">/</span>Imooc<span class="token operator">/</span>nodejs<span class="token operator">/</span>nodejs<span class="token operator">-</span>blog<span class="token operator">/</span>code<span class="token operator">-</span>demo<span class="token operator">/</span>blog<span class="token operator">-</span><span class="token number">1</span><span class="token operator">/</span>src<span class="token operator">/</span>utils<span class="token operator">/</span>copy<span class="token punctuation">.</span>sh

<span class="token comment">// 成功后通过如下查看所有的crontab任务</span>
$ crontab <span class="token operator">-</span>l
</code></pre></div><h3 id="分析日志-使用readline"><a href="#分析日志-使用readline" class="header-anchor">#</a> 分析日志 - 使用<code>readline</code></h3> <ul><li>如针对access.log日志，分析chrome的占比</li> <li>日志是按行存储的，一行就是一条日志</li> <li>使用nodejs的readline（基于stream，效率高）</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> readline <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'readline'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> fileName <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../'</span><span class="token punctuation">,</span> <span class="token string">'../'</span><span class="token punctuation">,</span> <span class="token string">'logs'</span><span class="token punctuation">,</span> <span class="token string">'access.log'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 创建 read stream</span>
<span class="token keyword">const</span> readStream <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span>

<span class="token comment">// 创建 readline 对象</span>
<span class="token keyword">const</span> rl <span class="token operator">=</span> readline<span class="token punctuation">.</span><span class="token function">createInterface</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    input<span class="token operator">:</span> readStream
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> chromeNum <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">let</span> sum <span class="token operator">=</span> <span class="token number">0</span>

<span class="token comment">// 逐行读取</span>
rl<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'line'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">lineData</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>lineData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    sum<span class="token operator">++</span>

    <span class="token keyword">const</span> arr <span class="token operator">=</span> lineData<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' -- '</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> arr<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'Chrome'</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        chromeNum<span class="token operator">++</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 监听读取完成</span>
rl<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'chrome 占比：'</span> <span class="token operator">+</span> chromeNum <span class="token operator">/</span> sum<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="第八章-安全-原生实现"><a href="#第八章-安全-原生实现" class="header-anchor">#</a> 第八章 - 安全（原生实现）</h2> <ol><li>sql注入：窃取数据库内容</li> <li>XSS攻击：窃取前端的cookie内容</li> <li>密码加密：保障用户信息安全（重要！）</li></ol> <ul><li>server端攻击方式非常多，预防手段也非常多</li> <li>本课只讲解常见的、能通过web server（nodejs）层面预防的
<ul><li>有些攻击需要硬件和服务来支持（需要OP支持），如DDOS攻击</li></ul></li></ul> <h3 id="sql注入"><a href="#sql注入" class="header-anchor">#</a> sql注入</h3> <ul><li><p>最原始、最简单的攻击，从有了web2.0就有了sql注入攻击</p></li> <li><p>攻击方式：输入一个sql片段，最终拼接成一段攻击代码</p></li> <li><p>预防措施：使用mysql的<code>escape函数</code>处理输入内容即可</p> <ul><li>所有会拼接成sql语句的用户输入变量，都需要使用 <code>mysql.escape(var1)</code> 转义</li></ul></li> <li><p>比如输入用户名时，故意输入为「zhangsan';delete from users;--」，这样在执行完查询后，会删除users表，非常危险</p></li></ul> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> username<span class="token punctuation">,</span> realname <span class="token keyword">from</span> users <span class="token keyword">where</span> username<span class="token operator">=</span><span class="token string">'zhangsan'</span><span class="token punctuation">;</span><span class="token keyword">delete</span> <span class="token keyword">from</span> users<span class="token punctuation">;</span>' <span class="token operator">and</span> password<span class="token operator">=</span><span class="token number">123</span>
</code></pre></div><ul><li>比如输入用户名时，故意输入为「zhangsan'--」，这样之后输入的密码就被注释掉了，则绕过了密码输入</li></ul> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> username<span class="token punctuation">,</span> realname <span class="token keyword">from</span> users <span class="token keyword">where</span> username<span class="token operator">=</span><span class="token string">'zhangsan'</span><span class="token comment">-- ' and password=123</span>
</code></pre></div><ul><li>escape转义：对username和password都添加escape转义，对比上面语句发现，zhangsan后的单引号前加了反斜杠，则注释不生效</li></ul> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> username<span class="token punctuation">,</span> realname <span class="token keyword">from</span> users <span class="token keyword">where</span> username<span class="token operator">=</span><span class="token string">'zhangsan\'-- '</span> <span class="token operator">and</span> password<span class="token operator">=</span><span class="token number">123</span>
</code></pre></div><h3 id="xss攻击"><a href="#xss攻击" class="header-anchor">#</a> XSS攻击</h3> <ul><li>攻击方式：在页面展示内容中掺杂js代码，以获取网页信息</li> <li>预防措施：转换生成js的特殊字符</li></ul> <p>比如在新建博客时，标题不输入文本而输入一段js代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>script<span class="token operator">&gt;</span><span class="token function">alert</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>cookie<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><p>这样在新建成功博客后，获取博客列表时，因为要获取标题展示，而这个博客的标题是上面这段js代码，则浏览器会执行它，把cookie alert出来；并且在该显示标题文本的地方什么也不显示。</p> <h4 id="安装-xss-依赖-完成转义"><a href="#安装-xss-依赖-完成转义" class="header-anchor">#</a> 安装 xss 依赖，完成转义</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 安装</span>
npm i xss <span class="token operator">-</span>s

<span class="token comment">// 使用</span>
<span class="token keyword">const</span> xss <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'xss'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> title <span class="token operator">=</span> <span class="token function">xss</span><span class="token punctuation">(</span>blogData<span class="token punctuation">.</span>title<span class="token punctuation">)</span>
</code></pre></div><p>特殊字符转换：特别是尖括号需要转换</p> <div class="language- extra-class"><pre class="language-text"><code>&amp; -&gt; &amp;amp;
&lt; -&gt; &amp;lt;
&gt; -&gt; &amp;gt;
&quot; -&gt; &amp;quot;
' -&gt; &amp;#x27;
/ -&gt; &amp;#x2F;
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>script<span class="token operator">&gt;</span><span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><p>转义后返回的内容是：</p> <div class="language- extra-class"><pre class="language-text"><code>&amp;lt;script&amp;gt;alert(2)&amp;lt;/script&amp;gt;
</code></pre></div><p>即输入的js脚本被转成字符串，也就不会执行，并且当前新建的博客标题可以显示为<code>&lt;script&gt;alert(2)&lt;/script&gt;</code></p> <h3 id="密码加密"><a href="#密码加密" class="header-anchor">#</a> 密码加密</h3> <ul><li>攻击方式：获取用户名和密码，再去尝试登录其他系统</li> <li>预防措施：将密码加密，即便拿到密码，也不知道明文
<ul><li>使用nodejs提供的 crypto依赖</li> <li>md5加密</li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 密钥</span>
<span class="token keyword">const</span> <span class="token constant">SECRET_KEY</span> <span class="token operator">=</span> <span class="token string">'WJiol_8776#'</span> <span class="token comment">// 随便写的</span>

<span class="token comment">// md5加密</span>
<span class="token keyword">function</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> md5 <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createHash</span><span class="token punctuation">(</span><span class="token string">'md5'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> md5<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 加密函数</span>
<span class="token keyword">function</span> <span class="token function">genPassword</span><span class="token punctuation">(</span><span class="token parameter">password</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> str <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">password=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>password<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;key=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">SECRET_KEY</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token keyword">return</span> <span class="token function">md5</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 对于每个密码，都通过密钥和md5加密生成了唯一的密文字符串</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">genPassword</span><span class="token punctuation">(</span><span class="token string">'123'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 524ab85686df0e52ada43b11b53cce35</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">genPassword</span><span class="token punctuation">(</span><span class="token string">'abc'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// dfcab4afe9e8b25d53c113b6deb5f429</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">genPassword</span><span class="token punctuation">(</span><span class="token string">'lsdfsdfsd'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// e3e9956c79530da45415cf3db1216606</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    genPassword
<span class="token punctuation">}</span>
</code></pre></div><h3 id="不使用框架开发-server-的最后总结"><a href="#不使用框架开发-server-的最后总结" class="header-anchor">#</a> 不使用框架开发 server 的最后总结</h3> <ul><li><p>开发了哪些功能模块，完整的流程</p> <ul><li>功能模块：6部分
<ul><li>处理http接口</li> <li>连接数据库</li> <li>实现登录</li> <li>日志</li> <li>安全</li> <li>上线</li></ul></li> <li>流程
<img src="/Roundtable/assets/img/process-memory.ce89aa67.png" alt="流程图"></li></ul></li> <li><p>用到了哪些核心的知识点</p> <ul><li>http，nodejs处理http、处理路由，mysql</li> <li>cookie，session，redis，nginx反向代理</li> <li>sql注入，xss攻击，加密</li> <li>日志，stream，crontab，readline</li> <li>线上环境的知识点</li></ul></li> <li><p>回顾“server和前端的区别”：5个区别</p> <ul><li>服务稳定性</li> <li>内存CPU（优化 扩展）</li> <li>日志记录</li> <li>安全（包括登录验证）</li> <li>集群和服务拆分（设计已支持）</li></ul></li></ul> <h2 id="第九章-使用express重构"><a href="#第九章-使用express重构" class="header-anchor">#</a> 第九章 - 使用express重构</h2> <h3 id="目录"><a href="#目录" class="header-anchor">#</a> 目录</h3> <ul><li>express下载、安装和使用，express中间件机制</li> <li>开发接口，连接数据库，实现登录，日志记录</li> <li>分析express中间件原理</li></ul> <h3 id="开始"><a href="#开始" class="header-anchor">#</a> 开始</h3> <ul><li>安装（使用脚手架 express-generator）
<ul><li>npm install express-generator -g</li> <li>express express-test // 初始化项目
<ul><li>npm i nodemon cross-env -D</li></ul></li> <li>npm install &amp; npm start</li></ul></li> <li>初始化代码介绍，处理路由<div class="language-js extra-class"><pre class="language-js"><code>tree <span class="token operator">-</span><span class="token constant">CI</span> <span class="token string">&quot;node_modules&quot;</span>

<span class="token punctuation">.</span>
├── app<span class="token punctuation">.</span>js <span class="token comment">// 应用代码</span>
├── bin
│   └── www <span class="token comment">// 执行app的服务，http.createServer(require('../app'))</span>
├── <span class="token keyword">package</span><span class="token operator">-</span>lock<span class="token punctuation">.</span>json
├── <span class="token keyword">package</span><span class="token punctuation">.</span>json
├── <span class="token keyword">public</span> <span class="token comment">// 静态文件</span>
│   ├── images
│   ├── javascripts
│   └── stylesheets
│       └── style<span class="token punctuation">.</span>css
├── routes <span class="token comment">// 路由</span>
│   ├── index<span class="token punctuation">.</span>js
│   └── users<span class="token punctuation">.</span>js
└── views <span class="token comment">// 模板</span>
    ├── error<span class="token punctuation">.</span>jade
    ├── index<span class="token punctuation">.</span>jade
    └── layout<span class="token punctuation">.</span>jade
</code></pre></div><ul><li>之所以有public和views目录，是因为初始化的代码并不只是一个web server的开发环境，而是一个全栈开发环境</li></ul></li> <li>使用中间件</li></ul> <h4 id="介绍express的入口代码-app-js"><a href="#介绍express的入口代码-app-js" class="header-anchor">#</a> 介绍express的入口代码（app.js）</h4> <ul><li>各个插件的作用，思考各个插件的实现原理（结合之前学过的知识）
<ul><li>express：
<ul><li>var app = express()；本次http请求的实例</li> <li>app.use(express.json())：处理post请求传的json数据，在路由中通过req.body拿到；</li> <li>app.use(express.urlencoded({ extended: false }))：处理post请求传的x-www-form-urlencoded格式数据，塞到req.body中，在路由中使用；</li></ul></li> <li>http-error：处理404</li> <li>cookie-parser：app.use(cookieParser)，可以在路由中通过req.cookies直接访问</li> <li>morgan：app.use(logger('dev'))，自动生成日志</li> <li>路由<div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 拆分路由</span>
<span class="token comment">// 这里设置的是根路径</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> indexRouter<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/users'</span><span class="token punctuation">,</span> usersRouter<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* GET home page. */</span>
<span class="token comment">// 这里设置的是子路径</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> title<span class="token operator">:</span> <span class="token string">'Express'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* GET users listing. */</span>
<span class="token comment">// 这里设置的是子路径</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'respond with a resource'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span class="token punctuation">;</span>
</code></pre></div></li></ul></li></ul> <h4 id="express如何处理路由"><a href="#express如何处理路由" class="header-anchor">#</a> express如何处理路由</h4> <ul><li>处理get请求和post请求</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> indexRouter<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/users'</span><span class="token punctuation">,</span> usersRouter<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/api/blog'</span><span class="token punctuation">,</span> blogRouter<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/api/user'</span><span class="token punctuation">,</span> userRouter<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// '/api/user/login'</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> username<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        errno<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        data<span class="token operator">:</span> <span class="token punctuation">{</span>
            username<span class="token punctuation">,</span>
            password
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span class="token punctuation">;</span>
</code></pre></div><h4 id="express中间件机制"><a href="#express中间件机制" class="header-anchor">#</a> express中间件机制</h4> <ul><li>所谓中间件，就是app.use、app.get、app.post中的一个个注册函数</li> <li>有很多app.use、app.get、app.post的情况下访问的流转是怎样的？
<ul><li>流转示例：当访问一个路由，比如get方式访问'/api/get-cookie'：
<ul><li>会先匹配app.use没有路由的所有路径
<ul><li>如果调用next()，则向下继续匹配执行</li> <li>如果没有next()，则停止</li></ul></li> <li>之后再匹配所有app.get方法中，所有父路径匹配上的，调用next()向下继续匹配
<ul><li>如果调用next()，则向下继续匹配执行</li> <li>如果没有next()，则停止</li></ul></li> <li>最后匹配所有app.get方法中完全匹配路径的</li></ul></li></ul></li> <li>代码中的next参数是什么？
<ul><li>中间件的注册函数有3个参数：(req, res, next)</li> <li>next函数的执行，会进入下一个中间件注册函数</li> <li>中间件注册函数可以有多个
<ul><li>app.get('/api/get-cookie', loginCheck, (req, res, next) =&gt; {})</li></ul></li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>

<span class="token comment">// 本次 http 请求的实例</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 所谓中间件，就是app.use、app.get、app.post中的一个个注册函数</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'请求开始...'</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>method<span class="token punctuation">,</span> req<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 假设在处理 cookie</span>
    req<span class="token punctuation">.</span>cookie <span class="token operator">=</span> <span class="token punctuation">{</span>
        userId<span class="token operator">:</span> <span class="token string">'abc123'</span>
    <span class="token punctuation">}</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 假设处理 post data</span>
    <span class="token comment">// 异步</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        req<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
            a<span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
            b<span class="token operator">:</span> <span class="token number">200</span>
        <span class="token punctuation">}</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/api'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'处理 /api 路由'</span><span class="token punctuation">)</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'get /api 路由'</span><span class="token punctuation">)</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'post /api 路由'</span><span class="token punctuation">)</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 模拟登录验证</span>
<span class="token keyword">function</span> <span class="token function">loginCheck</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'模拟登陆失败'</span><span class="token punctuation">)</span>
        res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            errno<span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
            msg<span class="token operator">:</span> <span class="token string">'登录失败'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token comment">// console.log('模拟登陆成功')</span>
        <span class="token comment">// next()</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 中间件注册函数可以有多个</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/get-cookie'</span><span class="token punctuation">,</span> loginCheck<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'get /api/get-cookie'</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        errno<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        data<span class="token operator">:</span> req<span class="token punctuation">.</span>cookie
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/get-post-data'</span><span class="token punctuation">,</span> loginCheck<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'post /api/get-post-data'</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        errno<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        data<span class="token operator">:</span> req<span class="token punctuation">.</span>body
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'处理 404'</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        errno<span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
        msg<span class="token operator">:</span> <span class="token string">'404 not fount'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'server is running on port 3000'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>所以脚手架生成的app.js这里其实都是中间件：</p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">logger</span><span class="token punctuation">(</span><span class="token string">'dev'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">{</span> extended<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cookieParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'public'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> indexRouter<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/users'</span><span class="token punctuation">,</span> usersRouter<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/api/blog'</span><span class="token punctuation">,</span> blogRouter<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/api/user'</span><span class="token punctuation">,</span> userRouter<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="express开发博客项目"><a href="#express开发博客项目" class="header-anchor">#</a> express开发博客项目</h3> <h4 id="express开发接口"><a href="#express开发接口" class="header-anchor">#</a> express开发接口</h4> <p>初始化项目，复用之前的部分代码</p> <p>开发路由，并实现登录</p> <p>记录日志</p> <p>初始化环境</p> <p>安装插件 mysql xss
mysql controller resModel 相关代码可以复用
初始化路由</p> <h4 id="express处理session"><a href="#express处理session" class="header-anchor">#</a> express处理session</h4> <ul><li>安装 express-session</li> <li>req.session 保存登录信息，登录校验做成express中间件</li></ul> <h4 id="express处理redis-session连接redis"><a href="#express处理redis-session连接redis" class="header-anchor">#</a> express处理redis（session连接redis）</h4> <ul><li>安装 redis</li> <li>安装 connect-redis</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> session <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express-session'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> RedisStore <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'connect-redis'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> blogRouter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./routes/blog'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> userRouter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./routes/user'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">logger</span><span class="token punctuation">(</span><span class="token string">'dev'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">{</span> extended<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cookieParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> redisClient <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./db/redis'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> sessionStore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisStore</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  client<span class="token operator">:</span> redisClient
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  secret<span class="token operator">:</span> <span class="token string">'WJiol_3476#'</span><span class="token punctuation">,</span>
  cookie<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// path: '/', // 默认</span>
    <span class="token comment">// httpOnly: true, // 默认</span>
    maxAge<span class="token operator">:</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  store<span class="token operator">:</span> sessionStore
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="登录中间件"><a href="#登录中间件" class="header-anchor">#</a> 登录中间件</h4> <h4 id="开发路由"><a href="#开发路由" class="header-anchor">#</a> 开发路由</h4> <h4 id="日志-morgan"><a href="#日志-morgan" class="header-anchor">#</a> 日志（morgan）</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token constant">ENV</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 开发环境</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">logger</span><span class="token punctuation">(</span><span class="token string">'dev'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    stream<span class="token operator">:</span> process<span class="token punctuation">.</span>stdout <span class="token comment">// 打印在控制台，其实这是默认配置</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">// 线上环境</span>
  <span class="token keyword">const</span> logFileName <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'logs'</span><span class="token punctuation">,</span> <span class="token string">'access.log'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> writeStream <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span>logFileName<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    flags<span class="token operator">:</span> <span class="token string">'a'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">logger</span><span class="token punctuation">(</span><span class="token string">'combined'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    stream<span class="token operator">:</span> writeStream
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h4> <ul><li>写法上的改变，如 req.query，res.json</li> <li>使用 express-session，connect-redis，登录中间件</li> <li>使用 morgan</li></ul> <h4 id="express中间件原理"><a href="#express中间件原理" class="header-anchor">#</a> express中间件原理</h4> <ul><li>回顾中间件使用
<ul><li>app.use：用来注册中间件，先收集起来</li> <li>遇到http请求，根据path和method判断触发哪些</li> <li>实现next机制，即上一个通过next触发下一个</li> <li>app.listen</li></ul></li> <li>分析如何实现</li> <li>代码实现</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> slice <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>slice<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">LikeExpress</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 存放中间件列表</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>routes <span class="token operator">=</span> <span class="token punctuation">{</span>
            all<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// app.use(...)</span>
            get<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// app.get(...)</span>
            post<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// app.post(...)</span>
            <span class="token comment">// put: [],</span>
            <span class="token comment">// patch: [],</span>
            <span class="token comment">// delete: [],</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">register</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> info <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> path <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            info<span class="token punctuation">.</span>path <span class="token operator">=</span> path
            <span class="token comment">// 从第二个参数开始，转换为数组，存入 stack</span>
            info<span class="token punctuation">.</span>stack <span class="token operator">=</span> <span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            info<span class="token punctuation">.</span>path <span class="token operator">=</span> <span class="token string">'/'</span>
            <span class="token comment">// 从第一个参数开始，转换为数组，存入 stack</span>
            info<span class="token punctuation">.</span>stack <span class="token operator">=</span> <span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> info
    <span class="token punctuation">}</span>

    <span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> info <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>routes<span class="token punctuation">.</span>all<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> info <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>routes<span class="token punctuation">.</span>get<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> info <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>routes<span class="token punctuation">.</span>post<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">match</span><span class="token punctuation">(</span><span class="token parameter">method<span class="token punctuation">,</span> url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> stack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>url <span class="token operator">===</span> <span class="token string">'/favicon.ico'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> stack
        <span class="token punctuation">}</span>

        <span class="token comment">// 获取 routes</span>
        <span class="token keyword">let</span> curRoutes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        curRoutes <span class="token operator">=</span> curRoutes<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>routes<span class="token punctuation">.</span>all<span class="token punctuation">)</span>
        curRoutes <span class="token operator">=</span> curRoutes<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>routes<span class="token punctuation">[</span>method<span class="token punctuation">]</span><span class="token punctuation">)</span>

        curRoutes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">routeInfo</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>routeInfo<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 以下都是匹配的情况</span>
                <span class="token comment">// url === '/api/get-cookie' 且 routeInfo.path === '/'</span>
                <span class="token comment">// url === '/api/get-cookie' 且 routeInfo.path === '/api'</span>
                <span class="token comment">// url === '/api/get-cookie' 且 routeInfo.path === '/api/get-cookie'</span>
                stack <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>routeInfo<span class="token punctuation">.</span>stack<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> stack
    <span class="token punctuation">}</span>

    <span class="token comment">// 核心的 next 机制</span>
    <span class="token function">handle</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> stack</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token function-variable function">next</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 拿到第一个匹配的中间件</span>
            <span class="token keyword">const</span> middleware <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>middleware<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 执行中间件函数</span>
                <span class="token function">middleware</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 需要定义下 res.json 函数</span>
            res<span class="token punctuation">.</span><span class="token function-variable function">json</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span>
                res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>
                    <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 通过url和method来匹配中间件list</span>
            <span class="token keyword">const</span> url <span class="token operator">=</span> req<span class="token punctuation">.</span>url
            <span class="token keyword">const</span> method <span class="token operator">=</span> req<span class="token punctuation">.</span>method<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token comment">// 中间件list</span>
            <span class="token keyword">const</span> resultList <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> url<span class="token punctuation">)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> resultList<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">listen</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 工厂函数</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LikeExpress</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="第十章-使用koa2重构"><a href="#第十章-使用koa2重构" class="header-anchor">#</a> 第十章 - 使用koa2重构</h2> <h3 id="koa2相比于express"><a href="#koa2相比于express" class="header-anchor">#</a> koa2相比于express</h3> <ul><li>相对于express中间件是异步回调，koa2原生支持 async/await</li> <li>新开发框架和系统，都开始基于koa2，例如egg.js</li> <li>express虽然未过时，但koa2肯定是未来趋势</li></ul> <h3 id="目录-2"><a href="#目录-2" class="header-anchor">#</a> 目录</h3> <ul><li>async/await 语法介绍，安装和使用koa2</li> <li>开发接口，连接数据库，实现登录，日志记录</li> <li>分析koa2中间件原理</li></ul> <h3 id="介绍koa2"><a href="#介绍koa2" class="header-anchor">#</a> 介绍koa2</h3> <p>koa2是express原班人马打造的轻量级框架，之前有一版koa，是用generator语法实现的，并不好用，koa2原生支持async/await。</p> <ul><li>npm install koa-generator -g // 安装</li> <li>Koa2 my-program // 初始化</li></ul> <h4 id="介绍koa2的入口代码-app-js"><a href="#介绍koa2的入口代码-app-js" class="header-anchor">#</a> 介绍koa2的入口代码（app.js）</h4> <ul><li>各个插件的作用，思考各个插件的实现原理（结合之前学过的知识）
<ul><li>koa2：
<ul><li>const app = new Koa()；本次http请求的实例</li> <li>const json = require('koa-json')；
<ul><li>app.use(json())：处理post请求传的json数据，在路由中通过req.body拿到；</li></ul></li> <li>const bodyparser = require('koa-bodyparser')</li> <li>app.use(bodyparser({
enableTypes:['json', 'form', 'text']
}))
<ul><li>在路由中通过ctx.request.body拿到；</li></ul></li></ul></li> <li>const onerror = require('koa-onerror')</li> <li>cookie-parser：app.use(cookieParser)，可以在路由中通过req.cookies直接访问</li> <li>const logger = require('koa-logger')；只是使控制台输出更加好看而已
<ul><li>生成日志还是需要使用 koa-morgan</li></ul></li></ul></li></ul> <h4 id="koa2如何处理路由"><a href="#koa2如何处理路由" class="header-anchor">#</a> koa2如何处理路由</h4> <ul><li>处理get请求和post请求</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-router'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">prefix</span><span class="token punctuation">(</span><span class="token string">'/api/blog'</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/list'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> query <span class="token operator">=</span> ctx<span class="token punctuation">.</span>query
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
        errno<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        query<span class="token punctuation">,</span>
        data<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'获取博客列表'</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-router'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">prefix</span><span class="token punctuation">(</span><span class="token string">'/api/user'</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> username<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body
    <span class="token keyword">const</span> query <span class="token operator">=</span> ctx<span class="token punctuation">.</span>query
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
        errno<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        username<span class="token punctuation">,</span>
        password
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router
</code></pre></div><h4 id="koa2中间件机制"><a href="#koa2中间件机制" class="header-anchor">#</a> koa2中间件机制</h4> <ul><li>所谓中间件，就是app.use、app.get、app.post中的一个个注册函数（async函数）</li> <li>有很多app.use、app.get、app.post的情况下访问的流转是怎样的？
<ul><li>流转示例：当访问一个路由，比如get方式访问'/api/get-cookie'：
<ul><li>会先匹配app.use没有路由的所有路径
<ul><li>如果调用 await next()，则向下继续匹配执行</li> <li>如果没有 await next()，则停止</li></ul></li> <li>之后再匹配所有app.get方法中，所有父路径匹配上的，调用 await next() 向下继续匹配
<ul><li>如果调用 await next()，则向下继续匹配执行</li> <li>如果没有 await next()，则停止</li></ul></li> <li>最后匹配所有app.get方法中完全匹配路径的</li></ul></li></ul></li> <li>代码中的next参数是什么？
<ul><li>中间件的注册函数有2个参数：(ctx, next)</li> <li>next函数的执行，会进入下一个中间件注册函数</li> <li>中间件注册函数可以有多个
<ul><li>app.get('/api/get-cookie', loginCheck, (ctx, next) =&gt; {})</li></ul></li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// logger</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> start <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> ms <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> - </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ms<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="koa2开发接口"><a href="#koa2开发接口" class="header-anchor">#</a> koa2开发接口</h4> <ul><li>实现登录
<ul><li>和express类似，基于 koa-generic-session 和 koa-redis<div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span>keys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'WJiol_3476#'</span><span class="token punctuation">]</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment">// 配置cookie</span>
    cookie<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// path: '/', // 默认</span>
        <span class="token comment">// httpOnly: true, // 默认</span>
        maxAge<span class="token operator">:</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 配置redis</span>
    store<span class="token operator">:</span> <span class="token function">redisStore</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        all<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">REDIS_CONF</span><span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">REDIS_CONF</span><span class="token punctuation">.</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div></li></ul></li> <li>开发路由
<ul><li>复用之前代码，如mysql，登录中间件，controller，model</li> <li>初始化路由，并开发接口</li> <li>联调测试</li></ul></li> <li>记录日志
<ul><li>access log 记录，使用morgan</li> <li>自定义日志使用console.log和console.error</li></ul></li></ul> <h4 id="koa2中间件原理"><a href="#koa2中间件原理" class="header-anchor">#</a> koa2中间件原理</h4> <p><em>koa2中间件本身没有路由功能，只有app.use</em></p> <ul><li>回顾中间件使用
<ul><li>洋葱圈模型：</li></ul> <div class="language- extra-class"><pre class="language-text"><code>第一层洋葱 - 开始
第二层洋葱 - 开始
第三层洋葱 - 开始
第三层洋葱 - 结束
第二层洋葱 - 结束
GET / - 4ms
第一层洋葱 - 结束
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// logger</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'第一层洋葱 - 开始'</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> rt <span class="token operator">=</span> ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'X-Response-Time'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> - </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>rt<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'第一层洋葱 - 结束'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// x-response-time</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'第二层洋葱 - 开始'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> start <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> ms <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'X-Response-Time'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ms<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'第二层洋葱 - 结束'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// response</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'第三层洋葱 - 开始'</span><span class="token punctuation">)</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'Hello World'</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'第三层洋葱 - 结束'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li>分析如何实现
<ul><li>app.use 用来注册中间件，先收集起来</li> <li>实现next机制，即上一个通过next触发下一个</li> <li>（因为koa2中间件本身没有路由功能，所以不涉及到 method 和 path 的判断）</li></ul></li> <li>代码实现<div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>

<span class="token comment">// 组合中间件</span>
<span class="token keyword">function</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token parameter">middlewareList</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 中间件调用</span>
        <span class="token keyword">function</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> fn <span class="token operator">=</span> middlewareList<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// 使用Promise.resolve包裹，是因为可能中间件函数fn传入的不是promise</span>
                <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>
                    <span class="token function">fn</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token function">dispatch</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// next机制</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">LikeKoa2</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>middlewareList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>

    <span class="token function">use</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>middlewareList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span>
    <span class="token punctuation">}</span>

    <span class="token function">createContext</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token punctuation">{</span>
            req<span class="token punctuation">,</span>
            res
        <span class="token punctuation">}</span>
        ctx<span class="token punctuation">.</span>query <span class="token operator">=</span> req<span class="token punctuation">.</span>query
        <span class="token keyword">return</span> ctx
    <span class="token punctuation">}</span>

    <span class="token function">handleRequest</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> fn <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>middlewareList<span class="token punctuation">)</span>

        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleRequest</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> fn<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">listen</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> LikeKoa2
</code></pre></div></li></ul> <h2 id="第十一章-线上环境配置"><a href="#第十一章-线上环境配置" class="header-anchor">#</a> 第十一章 线上环境配置</h2> <ul><li>服务器稳定性</li> <li>充分利用服务器硬件资源，以便提高性能</li> <li>线上日志记录</li></ul> <h3 id="pm2的核心价值"><a href="#pm2的核心价值" class="header-anchor">#</a> PM2的核心价值</h3> <ul><li><code>进程守护</code>，系统崩溃自动重启</li> <li><code>启动多进程</code>，充分利用CPU和内存</li> <li>自带<code>日志记录功能</code></li></ul> <h3 id="目录-3"><a href="#目录-3" class="header-anchor">#</a> 目录</h3> <h4 id="pm2介绍"><a href="#pm2介绍" class="header-anchor">#</a> PM2介绍</h4> <ul><li>和nodemon的区别
<ul><li>pm2是后台运行监听服务的，可以把命令行的权限再交还给前台</li> <li>nodemon是前台运行监听服务的，始终占用命令行</li></ul></li> <li>下载安装：npm i pm2 -g;
<ul><li><code>pm2 --version</code></li></ul></li> <li>常用命令：
<ul><li><code>pm2 start &lt;AppName&gt;/configFile</code> <ul><li>启动之后会把控制台控制权限交还给使用者</li></ul></li> <li><code>pm2 list</code></li> <li><code>pm2 restart &lt;AppName&gt;/id</code></li> <li><code>pm2 stop &lt;AppName&gt;/id</code></li> <li><code>pm2 delete &lt;AppName&gt;/id</code></li> <li><code>pm2 info &lt;AppName&gt;/id</code></li> <li><code>pm2 log &lt;AppName&gt;/id</code></li> <li><code>pm2 monit &lt;AppName&gt;/id</code> // 监控内存占用信息</li></ul></li></ul> <h4 id="pm2进程守护"><a href="#pm2进程守护" class="header-anchor">#</a> PM2进程守护</h4> <ul><li>node app.js 和 nodemon app.js，进程崩溃则不能访问</li> <li>pm2 遇到进程崩溃，会自动重启</li></ul> <h4 id="pm2配置和日志记录"><a href="#pm2配置和日志记录" class="header-anchor">#</a> PM2配置和日志记录</h4> <ul><li>新建 pm2配置文件（包括进程数量，日志文件目录等）
<ul><li>name：进程名称</li> <li>script：配置文件所执行的应用入口文件</li> <li>watch：代码改动是否监听重启</li> <li>err_file：错误日志输出地址</li> <li>out_file：输出日志输出地址</li></ul> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;apps&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;pm2-test-server&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;script&quot;</span><span class="token operator">:</span> <span class="token string">&quot;app.js&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;watch&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token property">&quot;ignore_watch&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">&quot;node_modules&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;logs&quot;</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">&quot;err_file&quot;</span><span class="token operator">:</span> <span class="token string">&quot;logs/err.log&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;out_file&quot;</span><span class="token operator">:</span> <span class="token string">&quot;logs/out.log&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;log_date_format&quot;</span><span class="token operator">:</span> <span class="token string">&quot;YYYY-MM-DD HH:MM:ss&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;instances&quot;</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li>修改 pm2启动命令，重启<div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;test&quot;</span><span class="token operator">:</span> <span class="token string">&quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cross-env NODE_ENV=dev nodemon app.js&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;prd&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cross-env NODE_ENV=production pm2 start pm2.conf.json&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div></li> <li>访问 server，检查日志文件的内容（日志记录是否生效）</li></ul> <h4 id="pm2多进程"><a href="#pm2多进程" class="header-anchor">#</a> PM2多进程</h4> <p>为什么使用多进程？</p> <ul><li>回顾之前讲session时说过，操作系统限制一个进程的内存</li> <li>内存：无法充分利用机器全部内存</li> <li>CPU：无法充分利用多核CPU的优势</li></ul> <p>多进程和redis</p> <ul><li>多进程之间，内存无法共享</li> <li>多进程访问一个redis，来实现数据共享</li></ul> <div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;instances&quot;</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
</code></pre></div><p>配置进程数量，多个进程开启后，mode为cluster集群模式，服务器会通过负载均衡规则，将当前请求派发到空闲的服务器进程上去。</p> <p><a href="https://www.zhaofinger.com/detail/5" target="_blank" rel="noopener noreferrer">使用pm2+nginx部署koa2(https)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">10/20/2020, 8:30:29 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Roundtable/Question-Bank/nodejs/benchmarking-tool.html" class="prev">
        压测工具简单实践
      </a></span> <span class="next"><a href="/Roundtable/Question-Bank/nodejs/eventEmitter.html">
        EventEmitter实现
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><div id="live2d-widget" class="live2d-widget-container" style="position:fixed;right:10px;bottom:-20px;width:290px;height:400px;z-index:99999;opacity:0.9;pointer-events:none;"><canvas id="live2dcanvas" width="290" height="400" class="live2dcanvas" style="position:absolute;left:0px;top:0px;width:290px;height:400px;"></canvas></div><!----><div class="reading-progress top" data-v-21b39eda><div class="progress" data-v-21b39eda></div></div><section class="side-anchor"><ul style="display:none;"></ul></section></div></div>
    <script src="/Roundtable/assets/js/app.2a67b391.js" defer></script><script src="/Roundtable/assets/js/3.732c8675.js" defer></script><script src="/Roundtable/assets/js/75.06e98b0d.js" defer></script>
  </body>
</html>
