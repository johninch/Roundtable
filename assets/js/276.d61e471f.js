(window.webpackJsonp=window.webpackJsonp||[]).push([[276],{852:function(t,s,a){"use strict";a.r(s);var n=a(14),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"node-模块机制的实现"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#node-模块机制的实现"}},[t._v("#")]),t._v(" Node 模块机制的实现")]),t._v(" "),a("h2",{attrs:{id:"commonjs-规范"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#commonjs-规范"}},[t._v("#")]),t._v(" CommonJS 规范")]),t._v(" "),a("p",[a("em",[t._v("希望 js 能运行在任何地方是 commonJS 规范制定的初衷。")]),t._v("\nCommonJS 对模块的定义非常简单，包括："),a("strong",[t._v("模块引用、模块定义、模块标识")]),t._v("；")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" 模块引用 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"模块标识"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/** 模块定义 */")]),t._v("\nexports"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("add")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("args")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("符合规范的"),a("strong",[t._v("模块标识")]),t._v("应该是小驼峰命名的字符串（如：my-module），或者路径。")]),t._v(" "),a("h2",{attrs:{id:"node-模块的实现"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#node-模块的实现"}},[t._v("#")]),t._v(" Node 模块的实现")]),t._v(" "),a("p",[t._v("前面了解了"),a("strong",[t._v("CommonJS")]),t._v("规范，现在再来 Node 对该规范的实现。\n"),a("code",[t._v("node")]),t._v("在实现该规范时做了一些取舍，同时也增加了部分自身需要的特性。我们知道规范的模块中有"),a("code",[t._v("exports")]),t._v("、"),a("code",[t._v("require")]),t._v("、"),a("code",[t._v("module")]),t._v("看起来十分简单，但我们需要了解"),a("strong",[t._v("node")]),t._v("在实现它们的时候经历了什么：")]),t._v(" "),a("h3",{attrs:{id:"node-如何加载模块"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#node-如何加载模块"}},[t._v("#")]),t._v(" Node 如何加载模块？")]),t._v(" "),a("p",[t._v("在 Node 中引入模块需要经历三个步骤：路径分析、文件定位、编译执行。")]),t._v(" "),a("h4",{attrs:{id:"模块的分类"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#模块的分类"}},[t._v("#")]),t._v(" 模块的分类")]),t._v(" "),a("p",[t._v("模块分为：核心模块（Node 自带的）、文件模块（用户写的）\n核心模块：在 node 源代码编译过程中编译成二进制，node 进程启动时直接装载在内存中执行，为何快？\n文件模块：属于动态加载，需要完成上述三个步骤才能完成加载。因此相对较慢。")]),t._v(" "),a("h4",{attrs:{id:"缓存优先"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#缓存优先"}},[t._v("#")]),t._v(" 缓存优先")]),t._v(" "),a("p",[t._v("当然了 Node 与浏览器类似，为了减少二次引入的开销，对引入过的模块都会进行缓存。不同的是，浏览器只缓存文件，Node 缓存的是编译和执行后的对象。")]),t._v(" "),a("h4",{attrs:{id:"路径分析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#路径分析"}},[t._v("#")]),t._v(" 路径分析")]),t._v(" "),a("ul",[a("li",[t._v("模块标识符分析")])]),t._v(" "),a("p",[t._v("模块标识符存在多种形式，对于不同形式查找和定位是有差异的。\n先了解一下模块标识符的分类：核心模块、相对路径的文件模块、绝对路径文件模块、非路径形式的文件模块（这里主要指包）。")]),t._v(" "),a("ul",[a("li",[t._v("提前看一下模块加载的优先级吧")])]),t._v(" "),a("p",[t._v("缓存 > 核心模块 > 路径形式的文件模块（以 "),a("code",[t._v(".")]),t._v(" 、"),a("code",[t._v("..")]),t._v("和"),a("code",[t._v("/")]),t._v("开头的标识符）> 自定义模块（非路径形式文件模块）。\n为何会存在这样的优先级呢，前面两个毋庸置疑，自定义模块最慢是为什么呢？")]),t._v(" "),a("ul",[a("li",[t._v("先了解一下自定义模块的路径查找策略：")])]),t._v(" "),a("p",[a("code",[t._v("module.paths")]),t._v("属性可以追踪模块的查找过程：首先在当前目录下的"),a("code",[t._v("node_modules")]),t._v("下查找，然后父目录...直到根目录，因此对于自定义模块路径越深查找越慢。")]),t._v(" "),a("h4",{attrs:{id:"文件定位"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#文件定位"}},[t._v("#")]),t._v(" 文件定位")]),t._v(" "),a("p",[t._v("在文件定位的过程中包括：文件扩展名分析、目录和包的处理。")]),t._v(" "),a("ul",[a("li",[t._v("文件扩展名分析")])]),t._v(" "),a("p",[t._v("由于标识符可以不带扩展名，此时"),a("code",[t._v("Node")]),t._v("会按照"),a("code",[t._v(".js")]),t._v("、"),a("code",[t._v(".json")]),t._v("、"),a("code",[t._v(".node")]),t._v(" 逐个尝试。在尝试的过程中，需要调用 fs 模块的同步阻塞式地判断文件是否存在。因为 Node 是单线程的，所以这里会引起性能问题。小诀窍 1：如果是.json、.node 请带上扩展名。小诀窍 2：同步配合缓存，可以大幅缓解 Node 单线程中阻塞式调用的缺陷。")]),t._v(" "),a("ul",[a("li",[t._v("目录分析和包")])]),t._v(" "),a("p",[t._v("文件扩展名分析后如果没有找到相应文件，却得到一个目录，此时会将此目录当作包处理：首先查找"),a("strong",[t._v("package.json")]),t._v("（"),a("strong",[t._v("CommonJS")]),t._v("包规范定义的包描述文件），并通过"),a("code",[t._v("JSON.parse()")]),t._v("解析，取出"),a("code",[t._v("main")]),t._v("属性指定的文件名进行定位。当"),a("code",[t._v("main")]),t._v("指定的文件名错误，或者根本不存在"),a("strong",[t._v("package.json")]),t._v("，"),a("strong",[t._v("Node")]),t._v("会将"),a("code",[t._v("index")]),t._v("作为默认文件名然后查找"),a("strong",[t._v("index.js 、index.json、index.node")]),t._v("。\n当模块路径数组遍历完毕后依然没找到，则会抛出查找失败的异常。")]),t._v(" "),a("h4",{attrs:{id:"模块编译"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#模块编译"}},[t._v("#")]),t._v(" 模块编译")]),t._v(" "),a("p",[t._v("当定位到具体文件后，Node 会创建一个模块对象，然后根据路径载入并编译。\n对于不同文件扩展名，加载方式一不一样：")]),t._v(" "),a("ul",[a("li",[t._v(".js 文件：通过 fs 模块同步读取后编译执行；")]),t._v(" "),a("li",[t._v(".node 文件：这是 C/C++编写的扩展文件，通过 dlopen()方法加载最后编译生成的文件。")]),t._v(" "),a("li",[t._v(",json 文件：fs 同步读取，JSON.parse()解析返回；")]),t._v(" "),a("li",[t._v("其余扩展名：都会被当作 .js 处理。")])]),t._v(" "),a("p",[t._v("每编译成功一个模块都会将其文件路径作为索引缓存在 Module._cache 对象上，以提高二次引入性能。\n根据不同文件扩展名，Node 会调用不同的读取方式，如.json 文件的调用如下：")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Native extensions for .json")]),t._v("\nModule"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_extensions"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"json"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("module"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" filename")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" content "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" NativeModule"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"fs"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("readFileSync")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("filename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"utf8"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tmodule"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exports "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("JSON")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("parse")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("content"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("catch")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\terr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("message "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" filename "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('": "')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("message"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throw")]),t._v(" err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("其中，Module._extensions 会赋值给 require 的 extensions 属性，不妨尝试："),a("code",[t._v("console.log(require.extensions);")]),t._v("\n也可以像上面的方式自定义扩展加载方式，v0.10.6 后官方不鼓励这么做，而是期望先将其他语言转换为 js 文件后再加载，这样就避免了将繁琐的编译加载等过程引入到 Node 的执行过程中。")]),t._v(" "),a("h5",{attrs:{id:"_1-javascript-模块编译"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-javascript-模块编译"}},[t._v("#")]),t._v(" 1. Javascript 模块编译")]),t._v(" "),a("p",[t._v("回到"),a("strong",[t._v("CommonJS")]),t._v("规范，我们知道每个文件都存在 "),a("code",[t._v("require")]),t._v("、"),a("code",[t._v("exports")]),t._v("、"),a("code",[t._v("module")]),t._v("三个变量，它们从何而来？Node 每个模块中还有"),a("code",[t._v("__filename")]),t._v("、"),a("code",[t._v("__dirname")]),t._v("，它们又从何而来。\n事实上在编译过程中，"),a("strong",[t._v("Node")]),t._v("会对获取的"),a("strong",[t._v("Javascript")]),t._v("文件内容进行头尾包装，如下：")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("exports"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" require"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" mudule"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" __filename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" __dirname")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" math "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"math"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\texports"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("area")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("radius")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" Math"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("PI")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" Math"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("pow")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("radius"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("这样就保证了模块文件之间作用域隔离。包装后的代码通过 vm 原生模块的"),a("code",[t._v("runInThisContext()")]),t._v("方法执行（类似"),a("code",[t._v("eval")]),t._v("，只是具有明确的上下文，不污染全局），返回一个具体的"),a("strong",[t._v("function")]),t._v("对象。\n以上，"),a("code",[t._v("require")]),t._v("、"),a("code",[t._v("exports")]),t._v("、"),a("code",[t._v("module")]),t._v("的流程已经完整，这就是"),a("strong",[t._v("Node")]),t._v("对"),a("strong",[t._v("CommonJS")]),t._v("模块规范的实现。")]),t._v(" "),a("h5",{attrs:{id:"_2-c-c-模块编译"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-c-c-模块编译"}},[t._v("#")]),t._v(" 2. C/C++模块编译")]),t._v(" "),a("p",[t._v("调用 process.dlopen()方法加载执行。在 Node 的架构中，dlopen()方法在 Windows 和*nix 平台分别有不同的实现，通过 libuv 兼容层进行封装。\n实际上.node 模块不需要编译，只需要加载和执行，执行过程中 exports 对象与.node 模块产生联系。")]),t._v(" "),a("h3",{attrs:{id:"核心模块"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#核心模块"}},[t._v("#")]),t._v(" 核心模块")]),t._v(" "),a("p",[t._v("核心模块分为两类：C/C++写的，JavaScript 写的。其中 C/C++放在 src 目录下，JavaScript 放在 lib 目录下。")]),t._v(" "),a("h4",{attrs:{id:"javascript-核心模块编译过程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#javascript-核心模块编译过程"}},[t._v("#")]),t._v(" JavaScript 核心模块编译过程")]),t._v(" "),a("ol",[a("li",[t._v("转存为 C/C++代码，代码字符串放到 c++数组中，Node 进程启动时直接加载到内存中。")]),t._v(" "),a("li",[t._v("编译 JavaScript 核心模块：")])]),t._v(" "),a("p",[t._v("与文件模块的区别在于：获取源代码的方式以及缓存执行保存结果的位置。\nJavascript 核心模块源代码通过 process.binding('natives')取出，编译成功后存放到 NativeModule._cache 对象上，文件模块则放在 Module._cache 对象上：")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("NativeModule")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("id")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("filename "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" id "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('".js"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("id "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exports "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("loaded "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nNativeModule"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_source "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" process"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("binding")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"natives"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 源代码缓存")]),t._v("\nNativeModule"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_cache "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 编译结果缓存")]),t._v("\n")])])]),a("h4",{attrs:{id:"c-c-核心模块的编译过程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#c-c-核心模块的编译过程"}},[t._v("#")]),t._v(" C/C++核心模块的编译过程")]),t._v(" "),a("p",[t._v("以后再说")]),t._v(" "),a("h4",{attrs:{id:"核心模块的引入流程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#核心模块的引入流程"}},[t._v("#")]),t._v(" 核心模块的引入流程")]),t._v(" "),a("p",[t._v("下面时 os 模块的引入流程：\n"),a("img",{attrs:{src:"https://cdn.nlark.com/yuque/__puml/a79ab39945bc20ec6e695f0038eb6f0f.svg#lake_card_v2=eyJjb2RlIjoiQHN0YXJ0dW1sXG5cbjpOT0RFX01PRFVMRShub2RlX29zLCByZWdfZnVuYyk7XG46Z2V0X2J1aWx0aW5fbW9kdWxlKCdub2RlX29zJyk7XG46cHJvY2Vzcy5iaW5kaW5nKCdvcycpO1xuOk5hdGl2ZU1vZHVsZS5yZXF1aXJlKCdvcycpO1xuOnJlcXVpcmUoJ29zJyk7XG5cbkBlbmR1bWwiLCJ0eXBlIjoicHVtbCIsImlkIjoiQllZaksiLCJ1cmwiOiJodHRwczovL2Nkbi5ubGFyay5jb20veXVxdWUvX19wdW1sL2E3OWFiMzk5NDViYzIwZWM2ZTY5NWYwMDM4ZWI2ZjBmLnN2ZyIsImNhcmQiOiJkaWFncmFtIn0=",alt:""}}),t._v("### C/C++扩展模块")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.nlark.com/yuque/__puml/57959b4e059dad9fc89f3ffd191838b7.svg#lake_card_v2=eyJjb2RlIjoiQHN0YXJ0dW1sXG5cbnwgKm5peHxcbjpDL0MrK-a6kOeggTtcbmlmICggKm5peClcblx0fCAqbml4fFxuXHQ6ZysrL2djYztcblx0LT4g57yW6K-R5rqQ56CBO1xuXHQ6LnNv5paH5Lu2O1xuXHQtPiDnlJ_miJAubm9kZeaWh-S7tjtcblx0OuWKoOi9vS5zb-aWh-S7tjtcblx0LT4gZGxvcGVuKCnliqDovb07XG5lbHNlXG5cdHwjQW50aXF1ZVdoaXRlfHdpbmRvd3N8XG5cdDpWQysrO1xuXHQtPiDnvJbor5HmupDnoIE7XG5cdDouZGxs5paH5Lu2O1xuXHQtPiDnlJ_miJAubm9kZeaWh-S7tjtcblx0OuWKoOi9vS5kbGzmlofku7Y7XG5cdC0-IGRsb3Blbigp5Yqg6L29O1xuZW5kaWZcbnwgKm5peHxcbjrlr7zlh7rnu5lKYXZhc2NyaXB0O1xuXG5AZW5kdW1sIiwidHlwZSI6InB1bWwiLCJpZCI6ImtuRVA1IiwidXJsIjoiaHR0cHM6Ly9jZG4ubmxhcmsuY29tL3l1cXVlL19fcHVtbC81Nzk1OWI0ZTA1OWRhZDlmYzg5ZjNmZmQxOTE4MzhiNy5zdmciLCJjYXJkIjoiZGlhZ3JhbSJ9",alt:""}}),t._v("扩展模块不同平台的编译和加载过程\n关于如何编写扩展模块，以及更多的相关信息，暂不深入了解。")]),t._v(" "),a("h2",{attrs:{id:"包与-npm"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#包与-npm"}},[t._v("#")]),t._v(" 包与 NPM")]),t._v(" "),a("p",[t._v("包是在模块的基础上进一步组织代码。")]),t._v(" "),a("h3",{attrs:{id:"包结构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#包结构"}},[t._v("#")]),t._v(" 包结构")]),t._v(" "),a("p",[t._v("包是一个存档文件，.zip 或.tar.gz 格式，安装后解压还原为目录。完全符合 CommonJS 规范的包目录应该包含如下文件：")]),t._v(" "),a("ul",[a("li",[t._v("package.json：包描述")]),t._v(" "),a("li",[t._v("bin: 存放可执行二进制文件的目录")]),t._v(" "),a("li",[t._v("lib：存放 JavaScript 代码")]),t._v(" "),a("li",[t._v("doc：文档")]),t._v(" "),a("li",[t._v("test：单元测试")])]),t._v(" "),a("h3",{attrs:{id:"包描述文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#包描述文件"}},[t._v("#")]),t._v(" 包描述文件")]),t._v(" "),a("p",[t._v("可以查看 npm 官方文档："),a("a",{attrs:{href:"https://docs.npmjs.com/files/package.json",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://docs.npmjs.com/files/package.json"),a("OutboundLink")],1)]),t._v(" "),a("h3",{attrs:{id:"包安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#包安装"}},[t._v("#")]),t._v(" 包安装")]),t._v(" "),a("h4",{attrs:{id:"全局安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#全局安装"}},[t._v("#")]),t._v(" 全局安装")]),t._v(" "),a("p",[t._v("全局安装并不代表将包安装为一个全局包，并不意味可以在任意地方引入。实际上 -g 是将一个包安装为全局可用的执行命令。它根据 package.json 的 bin 属性配置，将实际脚本链接到与 Node 可执行文件相同的路径下：")]),t._v(" "),a("div",{staticClass:"language-json extra-class"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"bin"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"express"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"./bin/exporess"')]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("事实上通过全局安装的包都被统一放到了一个目录下，如何知道这个目录呢？")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[t._v("path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolve")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("process"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("execPath"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('".."')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('".."')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"lib"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"node_modules"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("通过上面的代码即可推算出。如果 Node 的可执行文件在"),a("code",[t._v("/usr/local/bin/node")]),t._v("，那么模块目录就是"),a("code",[t._v("/usr/local/lib/node_modules")]),t._v("。最后，通过软链接的方式将"),a("code",[t._v("bin")]),t._v("属性配置的可执行文件链接到"),a("strong",[t._v("Node")]),t._v("的可执行目录下。")]),t._v(" "),a("h4",{attrs:{id:"本地安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#本地安装"}},[t._v("#")]),t._v(" 本地安装")]),t._v(" "),a("p",[t._v("本地安装只需要告诉"),a("strong",[t._v("NPM")]),t._v("包描述文件"),a("strong",[t._v("package.json")]),t._v("文件在哪就行。具体如下：")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("tarball file"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("tarball url"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("folder"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n")])])]),a("h4",{attrs:{id:"其他源安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#其他源安装"}},[t._v("#")]),t._v(" 其他源安装")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" react --registry"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("http://xxx.com\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 改变默认源")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" config "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("set")]),t._v(" registry http://xxx.com\n")])])]),a("h3",{attrs:{id:"npm-钩子命令"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#npm-钩子命令"}},[t._v("#")]),t._v(" NPM 钩子命令")]),t._v(" "),a("p",[t._v("package.json 中的 scripts 字段就是让包在安装或者卸载等过程中提供钩子机制，例如")]),t._v(" "),a("div",{staticClass:"language-json extra-class"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"scripts"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"preinstall"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"preinstall.js"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"install"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"install.js"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"uninstall"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"uninstall.js"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"test"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"test.js"')]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("当我们执行"),a("code",[t._v("npm install <package>")]),t._v("时，"),a("code",[t._v("preinstall")]),t._v("指向的脚本将会被加载执行，接着执行"),a("code",[t._v("install")]),t._v("。"),a("code",[t._v("npm uninstall <package>")]),t._v("时，"),a("code",[t._v("uninstall")]),t._v("字段指向的脚本可以执行一些清理操作。")]),t._v(" "),a("h3",{attrs:{id:"发布包"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#发布包"}},[t._v("#")]),t._v(" 发布包")]),t._v(" "),a("p",[t._v("流程：编写模块 -> 初始化 package.json -> 注册 npm 仓库账号（如果没有的话） -> 上传包。\n一个优秀的包应该：")]),t._v(" "),a("ul",[a("li",[t._v("具备良好的测试")]),t._v(" "),a("li",[t._v("具备良好的文档")]),t._v(" "),a("li",[t._v("具备良好的测试覆盖率")]),t._v(" "),a("li",[t._v("具备良好的编码规范")]),t._v(" "),a("li",[t._v("更多条件")])]),t._v(" "),a("h4",{attrs:{id:"注册仓库账号"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#注册仓库账号"}},[t._v("#")]),t._v(" 注册仓库账号")]),t._v(" "),a("p",[t._v("可以取 npm 官网注册，也可以通过命令行注册")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" adduser\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 而后按照指引填写即可")]),t._v("\n")])])]),a("h4",{attrs:{id:"上传包"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#上传包"}},[t._v("#")]),t._v(" 上传包")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" publish "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("folder"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n")])])]),a("h4",{attrs:{id:"包权限管理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#包权限管理"}},[t._v("#")]),t._v(" 包权限管理")]),t._v(" "),a("p",[t._v("通常一个包只有一个人可以发布。如果需要多人发布，可以使用：")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" owner "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ls")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("package name"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" owner "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("user"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("package name"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" owner "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("rm")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("user"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("package name"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n")])])]),a("p",[a("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/263240/1584441084190-4023bcec-dd64-4765-b4f9-48c1465b33ae.png#align=left&display=inline&height=38&name=image.png&originHeight=76&originWidth=384&size=7514&status=done&style=none&width=192",alt:"image.png"}})]),t._v(" "),a("h4",{attrs:{id:"分析包"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#分析包"}},[t._v("#")]),t._v(" 分析包")]),t._v(" "),a("p",[t._v("通过"),a("code",[t._v("npm ls")]),t._v(" 可以查看当前目录下能否顺利引入想引入的包。这个命令可以分析出当前路径下能通过模块路径找到的所有包，并生成依赖树：\n"),a("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2020/png/263240/1584441385320-e2a5d15d-70ab-4b4d-8c4f-3bad79497c7b.png#align=left&display=inline&height=44&name=image.png&originHeight=87&originWidth=291&size=5408&status=done&style=none&width=145.5",alt:"image.png"}})]),t._v(" "),a("h3",{attrs:{id:"局域网-npm"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#局域网-npm"}},[t._v("#")]),t._v(" 局域网 NPM")]),t._v(" "),a("p",[t._v("如何搭载且看：稍后更新。。。")]),t._v(" "),a("h2",{attrs:{id:"前后端共用模块"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前后端共用模块"}},[t._v("#")]),t._v(" 前后端共用模块")]),t._v(" "),a("p",[t._v("前端模块化主要有 AMD、CMD、ES6+。相关知识不赘述了。\n如何兼容多种规范，且看：")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" definition")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 检查上下文是否为AMD或CMD")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" hasDefine "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typeof")]),t._v(" define "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"function"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Node？")]),t._v("\n\t\thasExports "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typeof")]),t._v(" module "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"undefined"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" module"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exports"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hasDefine"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("define")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("definition"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hasExports"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tmodule"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exports "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("definition")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 挂到window上")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("definition")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"hello"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("hello")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" hello"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h2",{attrs:{id:"相关疑问"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#相关疑问"}},[t._v("#")]),t._v(" 相关疑问")]),t._v(" "),a("ul",[a("li",[t._v("包描述文件中"),a("strong",[t._v("dependencies")]),t._v("和"),a("strong",[t._v("devDependencies")]),t._v("的区别是什么？")])]),t._v(" "),a("p",[a("strong",[t._v("dependencies："),a("strong",[t._v("使用当前包所需要依赖的包列表，npm 会通过这个属性帮助自动加载依赖包。\n"),a("strong",[t._v("devDependencies："),a("strong",[t._v("一些模块只在开发时需要依赖。配置这个属性可以提示包的后续开发者安装这些依赖。\n所以对于包的使用者而言")]),t._v("devDependencies")]),t._v("列表的依赖是不需要加载的，如果这些也放在")]),t._v("dependencies")]),t._v("里边那么，使用者就会自动安装这些不想关的包。")]),t._v(" "),a("ul",[a("li",[t._v("如何编写好"),a("code",[t._v("package.json")]),t._v(" ？")])]),t._v(" "),a("p",[t._v("可以参考一下之名项目，例如：express："),a("a",{attrs:{href:"https://github.com/expressjs/express/blob/master/package.json",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/expressjs/express/blob/master/package.json"),a("OutboundLink")],1)])])}),[],!1,null,null,null);s.default=e.exports}}]);